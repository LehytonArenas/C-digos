---
title: "Caracterización Jericó"
author: "Lehyton Arenas"
date: "3/5/2021"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Directorio de trabajo:
setwd("/Volumes/Respaldo/Google Drive-Actualizado/Ecsim/2021_CaracterizaciónJericó/1_EntregablesLehyton")

# Paquetes a usar
library(tidyverse)
library(plyr); library(dplyr)
library(readxl)
library(writexl)
library(survey)
```

## Caracterización Data Primaria: sin FExp
```{r Data Primaria}
#### Datas primarias ####
# Por un error la convención de la data aparece como "Piloto...", pero no pasa nada
PilotoIndividuos <- read_excel("/Volumes/Respaldo/Google Drive-Actualizado/Ecsim/2021_CaracterizaciónJericó/2_EntregablesOtros/9_Arbey_DataExportada/20210713_DataV4.xlsx",sheet="p_039")

PilotoHogares <- read_excel("/Volumes/Respaldo/Google Drive-Actualizado/Ecsim/2021_CaracterizaciónJericó/2_EntregablesOtros/9_Arbey_DataExportada/20210713_DataV2.xlsx",sheet="Encuesta definitiva Jericó -...")

PilotoProyectos <- read_excel("/Volumes/Respaldo/Google Drive-Actualizado/Ecsim/2021_CaracterizaciónJericó/2_EntregablesOtros/9_Arbey_DataExportada/20210713_DataV2.xlsx",sheet="p_103_2")

#### Algunos cálculos propios ####

# Mejoramos la columna de localización:
PilotoProyectos <- PilotoProyectos %>% 
  dplyr::rename(Vereda="Corregimiento o vereda")

PilotoProyectos$Localizacion <- c("Localización")

PilotoProyectos <- PilotoProyectos %>%
  dplyr::mutate(Localizacion=ifelse(is.na(Vereda)==T,"Cabecera Urbana",Vereda))

# Hacemos el consolidado: urbano y rural
# Debemos eliminar veredas con *, pues no son representativas.
PilotoProyectos$LocaUrbRur <- c("Localización")

PilotoProyectos <- PilotoProyectos %>%
  dplyr:: filter(Localizacion!="Vereda Buga*",
                 Localizacion!="Vereda Vallecitos*",
                 Localizacion!="Vereda Cauca*",
                 Localizacion!="Vereda La Hermosa*",
                 Localizacion!="Vereda La Soledad*") %>% 
  dplyr::mutate(LocaUrbRur=ifelse(Localizacion=="Cabecera Urbana","Área Urbana","Área Rural"))

# hacemos el consolidad: Area de influencia
# Sin incluir veredas con *.

PilotoProyectos$LocaTotal <- c("Total Área de influencia")

#### Funciones ####
# Función agrupa: toma una data, la agrupa según la columna y calcula los %
# vamos a crear varias funciones, dependiendo del consolidado
AgrupaLoca <- function(Data,Columna){
  
  Data_v2 <- Data %>%
  dplyr::group_by(Localizacion) %>%
  dplyr::summarise(
    TotalLocalizacion = n())
  
  Data_v3 <- Data %>%
  dplyr::group_by(Localizacion,{{Columna}}) %>%
  dplyr::summarise(
    Subtotal = n())

  Data_v4 <- join_all(list(Data_v2,Data_v3), by=c("Localizacion"),type = "full")

  Data_v4 <- Data_v4 %>% 
  dplyr::mutate(Porcentaje=round((Subtotal/TotalLocalizacion)*100,2))

return(Data_v4)
}
AgrupaTotal <- function(Data,Columna){
  
  Data_v2 <- Data %>%
  dplyr::group_by(LocaTotal) %>%
  dplyr::summarise(
    TotalLocalizacion = n())
  
  Data_v3 <- Data %>%
  dplyr::group_by(LocaTotal,{{Columna}}) %>%
  dplyr::summarise(
    Subtotal = n())

  Data_v4 <- join_all(list(Data_v2,Data_v3), by=c("LocaTotal"),type = "full")

  Data_v4 <- Data_v4 %>% 
  dplyr::mutate(Porcentaje=round((Subtotal/TotalLocalizacion)*100,2))

return(Data_v4)
}
AgrupaUrbRur <- function(Data,Columna){
  
  Data_v2 <- Data %>%
  dplyr::group_by(LocaUrbRur) %>%
  dplyr::summarise(
    TotalLocalizacion = n())
  
  Data_v3 <- Data %>%
  dplyr::group_by(LocaUrbRur,{{Columna}}) %>%
  dplyr::summarise(
    Subtotal = n())

  Data_v4 <- join_all(list(Data_v2,Data_v3), by=c("LocaUrbRur"),type = "full")

  Data_v4 <- Data_v4 %>% 
  dplyr::mutate(Porcentaje=round((Subtotal/TotalLocalizacion)*100,2))

return(Data_v4)
}
```

```{r Modulo Características del hogar}
#### Tema: Jefe por sexo-Consolidado ####
Jefe <- PilotoIndividuos %>%
  dplyr::select(LocaTotal,LocaUrbRur,"${p_040}. Parentesco con el jefe del hogar:","Sexo de ${p_040}:") %>%
  dplyr::rename(Parentesco="${p_040}. Parentesco con el jefe del hogar:",
                SexoCol="Sexo de ${p_040}:") %>% 
  dplyr::filter(Parentesco=="Jefe(a) del hogar")

# Agrupamos como corresponde:
Jefe_v2 <- AgrupaTotal(Data=Jefe,Columna=SexoCol)
Jefe_v3 <- AgrupaUrbRur(Data=Jefe,Columna=SexoCol)

# Modificamos datas:
Jefe_v2 <- Jefe_v2 %>% 
  dplyr::select(LocaTotal,SexoCol,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Jefe_v3 <- Jefe_v3 %>% 
  dplyr::select(LocaUrbRur,SexoCol,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Jefe_v4 <- join_all(list(Jefe_v2,Jefe_v3), by=c("Localizacion"),type = "full")

# Graficamos:
ggplot(Jefe_v4, aes(x=Porcentaje,y=Localizacion,fill=SexoCol))+
  geom_col()+
  labs(x="Porcentaje",y="Localización",fill="Sexo del jefe de hogar:")+
  geom_text(aes(label = Porcentaje),position = position_stack(0.5),
            size=4, vjust=0.5, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top")+
  scale_x_continuous(limits=c(0,100))

# Eliminamos intermedios:
rm(Jefe,Jefe_v2,Jefe_v3,Jefe_v4)

#### Tema: Edad-Consolidado ####
# Pregunta data: "Edad de ${p_040}:"

Edades <- PilotoIndividuos %>%
  dplyr::select(.,c(Localizacion,LocaTotal,LocaUrbRur,"Edad de ${p_040}:")) %>%
  dplyr::rename(Edad="Edad de ${p_040}:")%>% 
  dplyr::filter(is.na(Edad)==F,
                Edad>0) # eliminamos valores negativos

# Transformamos data a tipo numérico
Edades$Edad <- as.numeric(Edades$Edad)

# Encontramos promedios de Edad por localización:
# Total Area:
Edades_v2 <- Edades %>% 
  dplyr::group_by(LocaTotal)%>%
    dplyr::summarise(
      EdadCol = round(mean(Edad,na.rm = TRUE),2)
      ) %>% 
  dplyr::rename(Localizacion=LocaTotal)

# Por Area :
Edades_v3 <- Edades %>% 
  dplyr::group_by(LocaUrbRur)%>%
    dplyr::summarise(
      EdadCol = round(mean(Edad,na.rm = TRUE),2)
      ) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Edades_v4 <- join_all(list(Edades_v2,Edades_v3), by=c("Localizacion"),type = "full")

# Graficamos:
ggplot(Edades_v4, aes(x=EdadCol,y=Localizacion))+
  geom_bar(stat="identity", position="dodge",fill="cyan4")+
  labs(x="Edad (promedio)",y="Localización")+
  geom_text(aes(label = EdadCol),position = position_dodge(1),
            size=4, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,50))+
  scale_fill_brewer(palette=1)

# Paso opcional: exportamos data:
write_xlsx(Tiempos, "HorasTrabajo.xlsx")

# Eliminamos intermedios:
rm(Edades,Edades_v2,Edades_v3,Edades_v4)


#### Tema: Sexo-Consolidado ####
# Pregunta data: "Sexo de ${p_040}:"

Sexo <- PilotoIndividuos %>%
  dplyr::select(Localizacion,LocaTotal,LocaUrbRur,"Sexo de ${p_040}:") %>%
  dplyr::rename(SexoCol="Sexo de ${p_040}:")

# Agrupamos como corresponde:
Sexo_v2 <- AgrupaLoca(Data=Sexo,Columna=SexoCol)
Sexo_v3 <- AgrupaTotal(Data=Sexo,Columna=SexoCol)
Sexo_v4 <- AgrupaUrbRur(Data=Sexo,Columna=SexoCol)

# Modificamos datas:
Sexo_v3 <- Sexo_v3 %>% 
  dplyr::select(LocaTotal,SexoCol,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Sexo_v4 <- Sexo_v4 %>% 
  dplyr::select(LocaUrbRur,SexoCol,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Sexo_v5 <- join_all(list(Sexo_v3,Sexo_v4), by=c("Localizacion"),type = "full")

# Graficamos:
ggplot(Sexo_v5, aes(x=Porcentaje,y=Localizacion,fill=SexoCol))+
  geom_col()+
  labs(x="Porcentaje",y="Localización",fill="Sexo:")+
  geom_text(aes(label = Porcentaje),position = position_stack(0.5),
            size=4, vjust=0.5, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top")+
  scale_x_continuous(limits=c(0,100))

# Paso opcional: exportamos data:
write_xlsx(Sexo_v5, "Sexo.xlsx")

# Eliminamos intermedios:
rm(Sexo,Sexo_v2,Sexo_v3,Sexo_v4,Sexo_v5)

#### Tema: Medios de información-Consolidado ####
# Preguntas data: 
#"${p_040}. ¿Qué medios usa principalmente para estar informado?..."

Informacion <- PilotoIndividuos %>%
  dplyr::select(LocaTotal,LocaUrbRur,
                "${p_040}. ¿Qué medios usa principalmente para estar informado?/Computador de escritorio",
                "${p_040}. ¿Qué medios usa principalmente para estar informado?/Computador portátil", 
                "${p_040}. ¿Qué medios usa principalmente para estar informado?/Tableta",
                "${p_040}. ¿Qué medios usa principalmente para estar informado?/Telefono celular",
                "${p_040}. ¿Qué medios usa principalmente para estar informado?/Televisor",
                "${p_040}. ¿Qué medios usa principalmente para estar informado?/Reproductor de radio",
                "${p_040}. ¿Qué medios usa principalmente para estar informado?/Periódico",
                "${p_040}. ¿Qué medios usa principalmente para estar informado?/Revistas",
                "${p_040}. ¿Qué medios usa principalmente para estar informado?/Ninguno") %>%
  dplyr::rename(Computador="${p_040}. ¿Qué medios usa principalmente para estar informado?/Computador de escritorio",
                Portatil="${p_040}. ¿Qué medios usa principalmente para estar informado?/Computador portátil",
                Tablet="${p_040}. ¿Qué medios usa principalmente para estar informado?/Tableta",
                Celular="${p_040}. ¿Qué medios usa principalmente para estar informado?/Telefono celular",
                Televisor="${p_040}. ¿Qué medios usa principalmente para estar informado?/Televisor",
                Radio="${p_040}. ¿Qué medios usa principalmente para estar informado?/Reproductor de radio",
                Periodico="${p_040}. ¿Qué medios usa principalmente para estar informado?/Periódico",
                Revistas="${p_040}. ¿Qué medios usa principalmente para estar informado?/Revistas",
                Ninguno="${p_040}. ¿Qué medios usa principalmente para estar informado?/Ninguno")

# Volvemos todas las columnaas en tipo numéricas:
Informacion$Computador <- as.numeric(Informacion$Computador)
Informacion$Portatil <- as.numeric(Informacion$Portatil)
Informacion$Tablet <- as.numeric(Informacion$Tablet)
Informacion$Celular <- as.numeric(Informacion$Celular)
Informacion$Televisor <- as.numeric(Informacion$Televisor)
Informacion$Radio <- as.numeric(Informacion$Radio)
Informacion$Periodico <- as.numeric(Informacion$Periodico)
Informacion$Revistas <- as.numeric(Informacion$Revistas)
Informacion$Ninguno <- as.numeric(Informacion$Ninguno)

# vamos a crear subgrupos por localidad y luego se concatenan. Para esto creamos una función:
# Funcion:
# Esta función usa la data inicial y la localización que queremos usar:
AgrupaInforma <- function(Data,LocalizacionCol,LocalizacionStr){
  
  DataLocaliza <- Data %>% 
  dplyr::filter({{LocalizacionCol}}==LocalizacionStr)

  DataLocaliza_v2 <- data.frame("Localizacion"=c(LocalizacionStr),
                      "Medio"=c("Computador","Portátil","Tablet","Celular","Televisor","Radio","Periódico","Revistas","Ninguno"),
                        "Subtotal"=colSums(DataLocaliza[,3:11], na.rm=T)
                        )

  DataLocaliza_v2$Total <- sum(DataLocaliza_v2$Subtotal)

  DataLocaliza_v2 <- DataLocaliza_v2 %>% 
  dplyr::mutate(Porcentaje=round((Subtotal/Total)*100,2))

return(DataLocaliza_v2)
}

# Aplicamos la función en cada localización:
Total <- AgrupaInforma(Data=Informacion,
                       LocalizacionCol=LocaTotal,
                       LocalizacionStr="Total Área de influencia")

Urbana <- AgrupaInforma(Data=Informacion,
                       LocalizacionCol=LocaUrbRur,
                       LocalizacionStr="Área Urbana")

Rural <- AgrupaInforma(Data=Informacion,
                       LocalizacionCol=LocaUrbRur,
                       LocalizacionStr="Área Rural")

# Concatenamos:
Informacion_v2 <- join_all(list(Total,Urbana,Rural), by=c("Localizacion"),type = "full")

Informacion_v2 <- Informacion_v2 %>% 
  dplyr::filter(Porcentaje>0)

# Gráfico: 
ggplot(Informacion_v2, aes(x=Porcentaje,y=Medio,fill=Localizacion))+
  geom_bar(stat="identity", position="dodge")+
  labs(x="Porcentaje",y="Medios de información",fill="Localización:")+
  geom_text(aes(label = Porcentaje),position = position_dodge(1),
            size=3, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,50))

# Eliminamos intermedios:
rm(Informacion,Informacion_v2,Rural,Urbana,Total,AgrupaInforma)



#### Tema: Frecuencia de Medios de información-Consolidado ####
# Pregunta data: "${p_040}. ¿Con qué frecuencia usa este medio?"

Frecuencia <- PilotoIndividuos %>%
  dplyr::select(LocaTotal,LocaUrbRur,"${p_040}. ¿Con qué frecuencia usa este medio?") %>%
  dplyr::rename(FrecuenciaCol="${p_040}. ¿Con qué frecuencia usa este medio?") %>%
  dplyr::filter(FrecuenciaCol!="No sabe",
                is.na(FrecuenciaCol)==F)

# Recodificamos variables:
Frecuencia$FrecuenciaShort <- c("Frecuencia")

Frecuencia <- Frecuencia %>% 
  dplyr::mutate(FrecuenciaShort=ifelse(FrecuenciaCol=="Todos los días de la semana","Todos los días",FrecuenciaShort),
                FrecuenciaShort=ifelse(FrecuenciaCol=="Al menos una vez a la semana pero no cada día","Al menos una vez a la semana",FrecuenciaShort),
                FrecuenciaShort=ifelse(FrecuenciaCol=="Al menos una vez al mes pero no cada semana","Al menos una vez al mes",FrecuenciaShort)
  )
                
# Agrupamos como corresponde:
Frecuencia_v2 <- AgrupaTotal(Data=Frecuencia,Columna=FrecuenciaShort)
Frecuencia_v3 <- AgrupaUrbRur(Data=Frecuencia,Columna=FrecuenciaShort)


# Modificamos datas:
Frecuencia_v2 <- Frecuencia_v2 %>% 
  dplyr::select(LocaTotal,FrecuenciaShort,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Frecuencia_v3 <- Frecuencia_v3 %>% 
  dplyr::select(LocaUrbRur,FrecuenciaShort,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Frecuencia_v4 <- join_all(list(Frecuencia_v2,Frecuencia_v3), by=c("Localizacion"),type = "full")

# Data en factores con orden predeterminado
Frecuencia_v4$FrecuenciaShort <- factor(Frecuencia_v4$FrecuenciaShort, levels=c("Todos los días","Al menos una vez a la semana","Al menos una vez al mes"))

# Gráfico: 
ggplot(Frecuencia_v4, aes(x=Porcentaje,y=FrecuenciaShort,fill=Localizacion))+
  geom_bar(stat="identity", position="dodge")+
  labs(x="Porcentaje",y="Frecuencia de uso",fill="Localización:")+
  geom_text(aes(label = Porcentaje),position = position_dodge(1),
            size=3, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,100))

# Eliminamos intermedios:
rm(Frecuencia,Frecuencia_v2,Frecuencia_v3,Frecuencia_v4)


#### Tema: Productos financieros-Consolidado ####
# Preguntas data: 
# "${p_040}. ¿Cuáles de los siguientes productos financieros usa principalmente?/...

Informacion <- PilotoIndividuos %>%
  dplyr::select(LocaTotal,LocaUrbRur,
                "${p_040}. ¿Cuáles de los siguientes productos financieros usa principalmente?/Cuenta corriente",
                "${p_040}. ¿Cuáles de los siguientes productos financieros usa principalmente?/Cuenta de ahorros",
                "${p_040}. ¿Cuáles de los siguientes productos financieros usa principalmente?/CDT",
                "${p_040}. ¿Cuáles de los siguientes productos financieros usa principalmente?/Préstamo para compra de vivienda",
                "${p_040}. ¿Cuáles de los siguientes productos financieros usa principalmente?/Préstamo para compra de vehículo",
                "${p_040}. ¿Cuáles de los siguientes productos financieros usa principalmente?/Préstamo para libre inversión",
                "${p_040}. ¿Cuáles de los siguientes productos financieros usa principalmente?/Tarjeta de crédito",
                "${p_040}. ¿Cuáles de los siguientes productos financieros usa principalmente?/Ninguno") %>%
  dplyr::rename(CtaCorriente="${p_040}. ¿Cuáles de los siguientes productos financieros usa principalmente?/Cuenta corriente",
                CtaAhorros="${p_040}. ¿Cuáles de los siguientes productos financieros usa principalmente?/Cuenta de ahorros",
                CDT="${p_040}. ¿Cuáles de los siguientes productos financieros usa principalmente?/CDT",
                PrestamoVivienda="${p_040}. ¿Cuáles de los siguientes productos financieros usa principalmente?/Préstamo para compra de vivienda",
                PrestamoCarro="${p_040}. ¿Cuáles de los siguientes productos financieros usa principalmente?/Préstamo para compra de vehículo",
                PrestamoLibre="${p_040}. ¿Cuáles de los siguientes productos financieros usa principalmente?/Préstamo para libre inversión",
                TarjetaCredito="${p_040}. ¿Cuáles de los siguientes productos financieros usa principalmente?/Tarjeta de crédito",
                Ninguno="${p_040}. ¿Cuáles de los siguientes productos financieros usa principalmente?/Ninguno")

# Volvemos todas las columnaas en tipo numéricas:
Informacion$CtaCorriente <- as.numeric(Informacion$CtaCorriente)
Informacion$CtaAhorros <- as.numeric(Informacion$CtaAhorros)
Informacion$CDT <- as.numeric(Informacion$CDT)
Informacion$PrestamoVivienda <- as.numeric(Informacion$PrestamoVivienda)
Informacion$PrestamoCarro <- as.numeric(Informacion$PrestamoCarro)
Informacion$PrestamoLibre <- as.numeric(Informacion$PrestamoLibre)
Informacion$TarjetaCredito <- as.numeric(Informacion$TarjetaCredito)
Informacion$Ninguno <- as.numeric(Informacion$Ninguno)

# vamos a crear subgrupos por localidad y luego se concatenan. Para esto creamos una función:
# Funcion:
# Esta función usa la data inicial y la localización que queremos usar:
AgrupaInforma <- function(Data,LocalizacionCol,LocalizacionStr){
  
  DataLocaliza <- Data %>% 
  dplyr::filter({{LocalizacionCol}}==LocalizacionStr)

  DataLocaliza_v2 <- data.frame("Localizacion"=c(LocalizacionStr),
                      "Medio"=c("Cta Corriente","Cta Ahorros","CDT","Préstamo Vivienda","Préstamo Carro","Préstamo Libre","Tarjeta Crédito","Ninguno"),
                        "Subtotal"=colSums(DataLocaliza[,3:10], na.rm=T)
                        )

  DataLocaliza_v2$Total <- sum(DataLocaliza_v2$Subtotal)

  DataLocaliza_v2 <- DataLocaliza_v2 %>% 
  dplyr::mutate(Porcentaje=round((Subtotal/Total)*100,2))

return(DataLocaliza_v2)
}

# Aplicamos la función en cada localización:
Total <- AgrupaInforma(Data=Informacion,
                       LocalizacionCol=LocaTotal,
                       LocalizacionStr="Total Área de influencia")

Urbana <- AgrupaInforma(Data=Informacion,
                       LocalizacionCol=LocaUrbRur,
                       LocalizacionStr="Área Urbana")

Rural <- AgrupaInforma(Data=Informacion,
                       LocalizacionCol=LocaUrbRur,
                       LocalizacionStr="Área Rural")

# Concatenamos:
Informacion_v2 <- join_all(list(Total,Urbana,Rural), by=c("Localizacion"),type = "full")

Informacion_v2 <- Informacion_v2 %>% 
  dplyr::filter(Porcentaje>0)

# Gráfico: 
ggplot(Informacion_v2, aes(x=Porcentaje,y=Medio,fill=Localizacion))+
  geom_bar(stat="identity", position="dodge")+
  labs(x="Porcentaje",y="Productos financieros",fill="Localización:")+
  geom_text(aes(label = Porcentaje),position = position_dodge(1),
            size=3, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,80))

# Eliminamos intermedios:
rm(Informacion,Informacion_v2,AgrupaInforma,Rural,Total,Urbana)

```

```{r Modulo Educación}
#### Tema: Condición educativa actual-Consolidado ####
# Pregunta de data: "${p_040}. ¿Cuál es su condición educativa actualmente?"
Educacion <- PilotoIndividuos %>%
  dplyr::select(LocaTotal,LocaUrbRur,"${p_040}. ¿Cuál es su condición educativa actualmente?") %>%
  dplyr::rename(CondicionEduca="${p_040}. ¿Cuál es su condición educativa actualmente?") %>% 
  dplyr::filter(.,CondicionEduca!="No responde",
                CondicionEduca!="No sabe",
                is.na(CondicionEduca)==F)

# Agrupamos como corresponde:
Educacion_v2 <- AgrupaTotal(Data=Educacion,Columna=CondicionEduca)
Educacion_v3 <- AgrupaUrbRur(Data=Educacion,Columna=CondicionEduca)


# Modificamos datas:
Educacion_v2 <- Educacion_v2 %>% 
  dplyr::select(LocaTotal,CondicionEduca,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Educacion_v3 <- Educacion_v3 %>% 
  dplyr::select(LocaUrbRur,CondicionEduca,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Educacion_v4 <- join_all(list(Educacion_v2,Educacion_v3), by=c("Localizacion"),type = "full")

# Graficamos:
ggplot(Educacion_v4, aes(x=Porcentaje,y=CondicionEduca,fill=Localizacion))+
  geom_bar(stat="identity", position="dodge")+
  labs(x="Porcentaje",y="Condición educativa actual",fill="Localización:")+
  geom_text(aes(label = Porcentaje),position = position_dodge(1),
            size=3.5, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,70))

# Paso opcional: exportamos data:
write_xlsx(Educacion_v2, "Ilu26_CondicionEduca.xlsx")

# Eliminamos intermedios:
rm(Educacion,Educacion_v2,Educacion_v3,Educacion_v4)

#### Tema: Causa para no continuar estudios-Consolidado ####
# Pregunta de data: "${p_040}. ¿Cuál fue la principal causa por la que no pudo continuar sus estudios?"

Educacion <- PilotoIndividuos %>%
  dplyr::select(LocaTotal,LocaUrbRur,"${p_040}. ¿Cuál fue la principal causa por la que no pudo continuar sus estudios?") %>%
  dplyr::rename(CausaNoEstudio="${p_040}. ¿Cuál fue la principal causa por la que no pudo continuar sus estudios?") %>% 
  dplyr::filter(.,CausaNoEstudio!="No responde",
                CausaNoEstudio!="No sabe",
                is.na(CausaNoEstudio)==F) 

# Recodificamos categorias: 
Educacion$CausaCol <- c("Causa")

Educacion <- Educacion %>% 
  dplyr::mutate(CausaCol=ifelse(CausaNoEstudio=="Considera que ya terminó sus estudios","Ya terminó",CausaCol),
                CausaCol=ifelse(CausaNoEstudio=="No le gusta o no le interesa el estudio, aburrición","No le interesa",CausaCol),
                CausaCol=ifelse(CausaNoEstudio=="Costos educativos elevados o falta de dinero","Costos educativos",CausaCol),
                CausaCol=ifelse(CausaNoEstudio=="Necesita trabajar","Necesita trabajar",CausaCol),
                CausaCol=ifelse(CausaNoEstudio=="No existe centro educativo cercano, está muy lejano","Lejanía del centro educativo",CausaCol),
                CausaCol=ifelse(CausaNoEstudio=="Por embarazo","Por embarazo",CausaCol),
                CausaCol=ifelse(CausaNoEstudio=="Falta de tiempo","Falta de tiempo",CausaCol),
                CausaCol=ifelse(CausaNoEstudio=="Recibe malos tratos en el colegio","Recibe malos tratos",CausaCol),
                CausaCol=ifelse(CausaNoEstudio=="Considera que no está en edad escolar","No está en edad escolar",CausaCol),
                CausaCol=ifelse(CausaNoEstudio=="Razones familiares","Razones familiares",CausaCol),
                CausaCol=ifelse(CausaNoEstudio=="Por enfermedad o incapacidad médica","Enfermedad o incapacidad",CausaCol),
                CausaCol=ifelse(CausaNoEstudio=="Porque se casó o formó pareja","Vida en pareja",CausaCol),
                CausaCol=ifelse(CausaNoEstudio=="Debe encargarse de los oficios del hogar (cuidado de los niños, ancianos, personas con discapacidad, etc)","Oficios del hogar",CausaCol),
                CausaCol=ifelse(CausaNoEstudio=="Necesita educación especial","Necesita educación especial",CausaCol),
                CausaCol=ifelse(CausaNoEstudio=="Por inseguridad en el establecimiento educativo, en el entorno del establecimiento o en el lugar de residencia","Inseguridad",CausaCol)  
                )

# Agrupamos como corresponde:
Educacion_v2 <- AgrupaTotal(Data=Educacion,Columna=CausaCol)
Educacion_v3 <- AgrupaUrbRur(Data=Educacion,Columna=CausaCol)

# Modificamos datas:
Educacion_v2 <- Educacion_v2 %>% 
  dplyr::select(LocaTotal,CausaCol,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Educacion_v3 <- Educacion_v3 %>% 
  dplyr::select(LocaUrbRur,CausaCol,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Educacion_v4 <- join_all(list(Educacion_v2,Educacion_v3), by=c("Localizacion"),type = "full")

# Graficamos:
ggplot(Educacion_v4, aes(x=Porcentaje,y=CausaCol,fill=Localizacion))+
  geom_bar(stat="identity", position="dodge")+
  labs(x="Porcentaje",y="Causas para no estudiar",fill="Localización:")+
  geom_text(aes(label = Porcentaje),position = position_dodge(1),
            size=2.8, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,50))

# Paso opcional: exportamos data:
write_xlsx(Educacion_v2, "Ilu26_CondicionEduca.xlsx")

# Eliminamos intermedios:
rm(Educacion,Educacion_v2,Educacion_v3,Educacion_v4)

#### Tema: Nivel de estudios que cursa actual-Consolidado ####
# Pregunta data: ${p_040}. ¿Cuál es el nivel actual de estudio?"
Educacion <- PilotoIndividuos %>%
  dplyr::select(LocaTotal,LocaUrbRur,"${p_040}. ¿Cuál es el nivel actual de estudio?") %>%
  dplyr::rename(NivelEstudio="${p_040}. ¿Cuál es el nivel actual de estudio?") %>% 
  dplyr::filter(NivelEstudio!="No sabe",
                is.na(NivelEstudio)==F)

# Agrupamos:
Educacion_v2 <- AgrupaTotal(Data=Educacion,
                 Columna=NivelEstudio)

Educacion_v3 <- AgrupaUrbRur(Data=Educacion,
                 Columna=NivelEstudio)

# Modificamos datas:
Educacion_v2 <- Educacion_v2 %>% 
  dplyr::select(LocaTotal,NivelEstudio,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Educacion_v3 <- Educacion_v3 %>% 
  dplyr::select(LocaUrbRur,NivelEstudio,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Educacion_v4 <- join_all(list(Educacion_v2,Educacion_v3), by=c("Localizacion"),type = "full")

# Data en factores con orden predeterminado
Educacion_v4$NivelEstudio <- factor(Educacion_v4$NivelEstudio, levels=c("Prescolar","Primaria (1º a 5º)","Secundaria (6º a 9º)","Media (10º a 11º)","Curso","Técnico","Tecnológico","Universidad","Especialización","Maestría","Doctorado"))

# Graficamos:
ggplot(Educacion_v4, aes(x=Porcentaje,y=NivelEstudio,fill=Localizacion))+
  geom_bar(stat="identity", position="dodge")+
  labs(x="Porcentaje",y="Nivel de estudios que cursa",fill="Localización:")+
  geom_text(aes(label = Porcentaje),position = position_dodge(1),
            size=3, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,50))

# Paso opcional: exportamos data:
write_xlsx(Educacion_v2, "Ilu28_NivelEduca.xlsx")

# Eliminamos intermedios:
rm(Educacion,Educacion_v2,Educacion_v3,Educacion_v4)

#### Tema: Area del conocimiento que cursa actualmente-Conso ####
# Pregunta de data: "${p_040}. Área de conocimiento de lo que está estudiando actualmente"
Educacion <- PilotoIndividuos %>%
  dplyr::select(LocaTotal,LocaUrbRur,"${p_040}. Área de conocimiento de lo que está estudiando actualmente") %>%
  dplyr::rename(AreaEstudio="${p_040}. Área de conocimiento de lo que está estudiando actualmente") %>% 
  dplyr::filter(.,AreaEstudio!="No responde",
                is.na(AreaEstudio)==F)

# Agrupamos:
Educacion_v2 <- AgrupaTotal(Data=Educacion,
                 Columna=AreaEstudio)

Educacion_v3 <- AgrupaUrbRur(Data=Educacion,
                 Columna=AreaEstudio)

# Modificamos datas:
Educacion_v2 <- Educacion_v2 %>% 
  dplyr::select(LocaTotal,AreaEstudio,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Educacion_v3 <- Educacion_v3 %>% 
  dplyr::select(LocaUrbRur,AreaEstudio,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Educacion_v4 <- join_all(list(Educacion_v2,Educacion_v3), by=c("Localizacion"),type = "full")

# Graficamos:
ggplot(Educacion_v4, aes(x=Porcentaje,y=AreaEstudio,fill=Localizacion))+
  geom_bar(stat="identity", position="dodge")+
  labs(x="Porcentaje",y="Área del conocimiento que cursa",fill="Localización:")+
  geom_text(aes(label = Porcentaje),position = position_dodge(1),
            size=3, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,35))

# Paso opcional: exportamos data:
write_xlsx(Educacion_v2, "Ilu28_NivelEduca.xlsx")

# Eliminamos intermedios:
rm(Educacion,Educacion_v2,Educacion_v3,Educacion_v4)

#### Tema: Ultimo título aprobado-Consolidado ####
# Pregunta data: "${p_040}. Último título de estudio aprobado."

Educacion <- PilotoIndividuos %>%
  dplyr::select(LocaTotal,LocaUrbRur,"${p_040}. Último título de estudio aprobado.") %>%
  dplyr::rename(Titulo="${p_040}. Último título de estudio aprobado.")%>% 
  dplyr::filter(Titulo!="No responde",
                Titulo!="No sabe",
                is.na(Titulo)==F)

# Agrupamos:
Educacion_v2 <- AgrupaTotal(Data=Educacion,
                 Columna=Titulo)

Educacion_v3 <- AgrupaUrbRur(Data=Educacion,
                 Columna=Titulo)

# Modificamos datas:
Educacion_v2 <- Educacion_v2 %>% 
  dplyr::select(LocaTotal,Titulo,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Educacion_v3 <- Educacion_v3 %>% 
  dplyr::select(LocaUrbRur,Titulo,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Educacion_v4 <- join_all(list(Educacion_v2,Educacion_v3), by=c("Localizacion"),type = "full")

# Data en factores con orden predeterminado
Educacion_v4$Titulo <- factor(Educacion_v4$Titulo, levels=c("Ninguno","Prescolar","Primaria (1º a 5º)","Secundaria (6º a 9º)", "Media (10º a 11º)","Técnico","Tecnológico","Universidad","Especialización","Maestría"))

# Graficamos:
ggplot(Educacion_v4, aes(x=Porcentaje,y=Titulo,fill=Localizacion))+
  geom_bar(stat="identity", position="dodge")+
  labs(x="Porcentaje",y="Último título aprobado",fill="Localización:")+
  geom_text(aes(label = Porcentaje),position = position_dodge(1),
            size=3, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,50))

# Paso opcional: exportamos data:
write_xlsx(Educacion_v2, "Ilu28_NivelEduca.xlsx")

# Eliminamos intermedios:
rm(Educacion,Educacion_v2,Educacion_v3,Educacion_v4)

#### Tema: Area del conocimiento Ultimo título-Consolidado ####
# Pregunta de data: "${p_040}. Área de conocimiento en la que obtuvo el título."
Educacion <- PilotoIndividuos %>%
  dplyr::select(LocaTotal,LocaUrbRur,"${p_040}. Área de conocimiento en la que obtuvo el título.") %>%
  dplyr::rename(AreaEstudio="${p_040}. Área de conocimiento en la que obtuvo el título.") %>% 
  dplyr::filter(.,AreaEstudio!="No responde",
                is.na(AreaEstudio)==F)

# Agrupamos:
Educacion_v2 <- AgrupaTotal(Data=Educacion,
                 Columna=AreaEstudio)

Educacion_v3 <- AgrupaUrbRur(Data=Educacion,
                 Columna=AreaEstudio)

# Modificamos datas:
Educacion_v2 <- Educacion_v2 %>% 
  dplyr::select(LocaTotal,AreaEstudio,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Educacion_v3 <- Educacion_v3 %>% 
  dplyr::select(LocaUrbRur,AreaEstudio,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Educacion_v4 <- join_all(list(Educacion_v2,Educacion_v3), by=c("Localizacion"),type = "full")

# Graficamos:
ggplot(Educacion_v4, aes(x=Porcentaje,y=AreaEstudio,fill=Localizacion))+
  geom_bar(stat="identity", position="dodge")+
  labs(x="Porcentaje",y="Área del conocimiento del último título",fill="Localización:")+
  geom_text(aes(label = Porcentaje),position = position_dodge(1),
            size=3, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,35))

# Paso opcional: exportamos data:
write_xlsx(Educacion_v2, "Ilu28_NivelEduca.xlsx")

# Eliminamos intermedios:
rm(Educacion,Educacion_v2,Educacion_v3,Educacion_v4)

#### Tema: Intereses académicos a futuro V1-Consolidado ####
# Se deben hacer unas modificaciones en la data:

# Traemos las columnas de interés, renombramos y filtramos:
DataFiltrada <- PilotoIndividuos %>% 
  dplyr::select(LocaTotal,LocaUrbRur,
                "${p_040}. ¿Cuál es su condición educativa actualmente?",
                "${p_040}. ¿Cuál es el nivel actual de estudio?",
                "${p_040}. Último NIVEL de estudio que estudió.",
                "${p_040}. ¿Cuáles son sus intereses académicos a futuro? (¿Qué le gustaría aprender?)") %>% 
  dplyr::rename(CondicionEduca="${p_040}. ¿Cuál es su condición educativa actualmente?",
                NivelActual="${p_040}. ¿Cuál es el nivel actual de estudio?",
                NivelUltimo="${p_040}. Último NIVEL de estudio que estudió.",
                InteresEducativo="${p_040}. ¿Cuáles son sus intereses académicos a futuro? (¿Qué le gustaría aprender?)") %>% 
  dplyr::filter(is.na(InteresEducativo)==F,
                InteresEducativo!="No responde",
                InteresEducativo!="No sabe",
                InteresEducativo!="Retomar estudios diferente a lo que estaba estudiando")

# Creamos dos variables ficticias:
DataFiltrada$InteresEducativoV2 <- c("InterésV2") # La vincularemos con retomar estudios pasados
DataFiltrada$InteresEducativoV3 <- c("InterésV3") # La vincularemos con terminar estudios actuales.

# Recodificamos variables ficticias:
DataFiltrada <- DataFiltrada %>% 
  dplyr::mutate(InteresEducativoV2=ifelse(InteresEducativo=="Retomar estudios en lo que estaba estudiando",NivelUltimo,InteresEducativoV2),
                InteresEducativoV2=ifelse(is.na(InteresEducativoV2)==T,NivelActual,InteresEducativoV2),
                InteresEducativoV3=ifelse(InteresEducativo=="Terminar estudios actuales (solo para quien estudia)",NivelActual,InteresEducativoV3)
                )

# Creamos ultima variable ficticia
# Será la vble más importante, pues retomará todas las variables previas:
DataFiltrada$InteresEducativoV4 <- c("InterésV4")

# Recodificamos última variable ficticia: recogiendo todos los valores de interés
# Renombramos o recodificamos valores para unificar criterios.
# Filtrmos
DataFiltrada <- DataFiltrada %>% 
  dplyr::mutate(InteresEducativoV4=ifelse(InteresEducativoV2!="InterésV2",InteresEducativoV2,InteresEducativoV4),
                InteresEducativoV4=ifelse(InteresEducativoV3!="InterésV3",InteresEducativoV3,InteresEducativoV4),
                InteresEducativoV4=ifelse(InteresEducativoV4=="InterésV4",InteresEducativo,InteresEducativoV4),
                InteresEducativoV4=ifelse(InteresEducativoV4=="Primaria (1º a 5º)","Estudiar la primaria",InteresEducativoV4),
                InteresEducativoV4=ifelse(InteresEducativoV4=="Técnico","Estudiar una técnica",InteresEducativoV4),
                InteresEducativoV4=ifelse(InteresEducativoV4=="Secundaria (6º a 9º)","Estudiar la secundaria",InteresEducativoV4),
                InteresEducativoV4=ifelse(InteresEducativoV4=="Universidad","Estudiar un pregrado",InteresEducativoV4),
                InteresEducativoV4=ifelse(InteresEducativoV4=="Tecnológico","Estudiar una tecnología",InteresEducativoV4),
                InteresEducativoV4=ifelse(InteresEducativoV4=="Media (10º a 11º)","Estudiar la media",InteresEducativoV4),
                InteresEducativoV4=ifelse(InteresEducativoV4=="Especialización","Estudiar un posgrado",InteresEducativoV4),
                InteresEducativoV4=ifelse(InteresEducativoV4=="Doctorado","Estudiar un posgrado",InteresEducativoV4),
                InteresEducativoV4=ifelse(InteresEducativoV4=="Maestría","Estudiar un posgrado",InteresEducativoV4)
  ) %>% 
  dplyr::filter(is.na(InteresEducativoV4)==F,
                InteresEducativoV4!="No sabe")

# Agrupamos:
DataFiltrada_v2 <- AgrupaTotal(Data=DataFiltrada,
                 Columna=InteresEducativoV4)

DataFiltrada_v3 <- AgrupaUrbRur(Data=DataFiltrada,
                 Columna=InteresEducativoV4)

# Modificamos datas:
DataFiltrada_v2 <- DataFiltrada_v2 %>% 
  dplyr::select(LocaTotal,InteresEducativoV4,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

DataFiltrada_v3 <- DataFiltrada_v3 %>% 
  dplyr::select(LocaUrbRur,InteresEducativoV4,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
DataFiltrada_v4 <- join_all(list(DataFiltrada_v2,DataFiltrada_v3), by=c("Localizacion"),type = "full")

# Data en factores con orden predeterminado
DataFiltrada_v4$InteresEducativoV4 <- factor(DataFiltrada_v4$InteresEducativoV4, levels=c("No tiene intereses académicos","Estudiar la primaria","Estudiar la secundaria","Estudiar la media","Estudiar una técnica","Estudiar una tecnología","Estudiar un pregrado","Estudiar un posgrado"))

# Graficamos:
ggplot(DataFiltrada_v4, aes(x=Porcentaje,y=InteresEducativoV4,fill=Localizacion))+
  geom_bar(stat="identity", position="dodge")+
  labs(x="Porcentaje",y="Interés académico a fuuro",fill="Localización:")+
  geom_text(aes(label = Porcentaje),position = position_dodge(1),
            size=3, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,75))

# Paso opcional: exportamos data:
write_xlsx(DataFiltrada_v2, "Ilu28_NivelEduca.xlsx")

# Eliminamos intermedios:
rm(DataFiltrada,DataFiltrada_v2,DataFiltrada_v3,DataFiltrada_v4)

```

```{r Modulo Seguridad Social}
#### Tema: Afiliación al SSS-Consolidado ####

#"Afiliación al Sistema de Seguridad Social en Salud Agrupado"
AfiliacionSSS <- PilotoIndividuos %>%
  dplyr::select(LocaTotal,LocaUrbRur,"Afiliación al Sistema de Seguridad Social en Salud Agrupado") %>%
  dplyr::rename(AfiliacionCol="Afiliación al Sistema de Seguridad Social en Salud Agrupado")  %>% 
  dplyr::filter(.,AfiliacionCol!="No responde",
                is.na(AfiliacionCol)==F)

Afiliacion_v2 <- AgrupaTotal(Data=AfiliacionSSS,
                 Columna=AfiliacionCol)

Afiliacion_v3 <- AgrupaUrbRur(Data=AfiliacionSSS,
                 Columna=AfiliacionCol)

# Modificamos datas:
Afiliacion_v2 <- Afiliacion_v2 %>% 
  dplyr::select(LocaTotal,AfiliacionCol,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Afiliacion_v3 <- Afiliacion_v3 %>% 
  dplyr::select(LocaUrbRur,AfiliacionCol,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Afiliacion_v4 <- join_all(list(Afiliacion_v2,Afiliacion_v3), by=c("Localizacion"),type = "full")

# Graficamos:
ggplot(Afiliacion_v4, aes(x=Porcentaje,y=AfiliacionCol,fill=Localizacion))+
  geom_bar(stat="identity", position="dodge")+
  labs(x="Porcentaje",y="Afiliación al sistema de salud",fill="Localización:")+
  geom_text(aes(label = Porcentaje),position = position_dodge(1),
            size=3, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,65))

# Eliminamos intermedios:
rm(AfiliacionSSS,Afiliacion_v2,Afiliacion_v3,Afiliacion_v4)

#### Tema: Calificación: Servicios Salud-Consolidado  ####
# Pregunta data: "${p_040}. Según su opinión, ¿cómo califica la calidad de los servicios de salud?"

Salud <- PilotoIndividuos %>%
  dplyr::select(.,c(LocaTotal,LocaUrbRur,"${p_040}. Según su opinión, ¿cómo califica la calidad de los servicios de salud?")) %>%
  dplyr::rename(Calificacion="${p_040}. Según su opinión, ¿cómo califica la calidad de los servicios de salud?") %>% 
  dplyr::filter(Calificacion!="No se encuentra en casa",
                Calificacion!="No responde",
                is.na(Calificacion)==F)

# Agrupamos como corresponde:

Salud_v2 <- AgrupaTotal(Data=Salud,
                 Columna=Calificacion)

Salud_v3 <- AgrupaUrbRur(Data=Salud,
                 Columna=Calificacion)

# Modificamos datas:
Salud_v2 <- Salud_v2 %>% 
  dplyr::select(LocaTotal,Calificacion,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Salud_v3 <- Salud_v3 %>% 
  dplyr::select(LocaUrbRur,Calificacion,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Salud_v4 <- join_all(list(Salud_v2,Salud_v3), by=c("Localizacion"),type = "full")

# Data en factores con orden predeterminado
Salud_v4$Calificacion <- factor(Salud_v4$Calificacion, levels=c("Malo","Regular","Bueno"))

# Graficamos:
ggplot(Salud_v4, aes(x=Porcentaje,y=Calificacion,fill=Localizacion))+
  geom_bar(stat="identity", position="dodge")+
  labs(x="Porcentaje",y="Calificación de servicios de salud",fill="Localización:")+
  geom_text(aes(label = Porcentaje),position = position_dodge(1),
            size=3, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,75))

# Eliminamos intermedios:
rm(Salud,Salud_v2,Salud_v3,Salud_v4)


#### Tema: Cotiza para pensión-Consolidado  ####
# Pregunta data: "${p_040}. ¿Cotiza para pensión?"

Salud <- PilotoIndividuos %>%
  dplyr::select(.,c(LocaTotal,LocaUrbRur,"${p_040}. ¿Cotiza para pensión?")) %>%
  dplyr::rename(Cotiza="${p_040}. ¿Cotiza para pensión?") %>% 
  dplyr::filter(Cotiza!="No responde",
                Cotiza!="No sabe",
                is.na(Cotiza)==F)

# Agrupamos como corresponde:

Salud_v2 <- AgrupaTotal(Data=Salud,
                 Columna=Cotiza)

Salud_v3 <- AgrupaUrbRur(Data=Salud,
                 Columna=Cotiza)

# Modificamos datas:
Salud_v2 <- Salud_v2 %>% 
  dplyr::select(LocaTotal,Cotiza,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Salud_v3 <- Salud_v3 %>% 
  dplyr::select(LocaUrbRur,Cotiza,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Salud_v4 <- join_all(list(Salud_v2,Salud_v3), by=c("Localizacion"),type = "full")

# Graficamos:
# Graficamos:
ggplot(Salud_v4, aes(x=Porcentaje,y=Localizacion,fill=Cotiza))+
  geom_col()+
  labs(x="Porcentaje",y="Localización",fill="Cotiza al sistema de pensión:")+
  geom_text(aes(label = Porcentaje),position = position_stack(0.5),
            size=4, vjust=0.5, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top")+
  scale_x_continuous(limits=c(0,100))
# Eliminamos intermedios
rm(Salud,Salud_v2,Salud_v3,Salud_v4)

#### Tema: Está afiliado a ARL-Consolidado  ####
# Pregunta data: "${p_040}. ¿Tiene Afiliación a una Administradora de Riesgos Laborales (ARL)?"

Salud <- PilotoIndividuos %>%
  dplyr::select(.,c(LocaTotal,LocaUrbRur,"${p_040}. ¿Tiene Afiliación a una Administradora de Riesgos Laborales (ARL)?")) %>%
  dplyr::rename(Cotiza="${p_040}. ¿Tiene Afiliación a una Administradora de Riesgos Laborales (ARL)?") %>% 
  dplyr::filter(Cotiza!="No responde",
                Cotiza!="No sabe",
                is.na(Cotiza)==F)

# Agrupamos como corresponde:

Salud_v2 <- AgrupaTotal(Data=Salud,
                 Columna=Cotiza)

Salud_v3 <- AgrupaUrbRur(Data=Salud,
                 Columna=Cotiza)

# Modificamos datas:
Salud_v2 <- Salud_v2 %>% 
  dplyr::select(LocaTotal,Cotiza,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Salud_v3 <- Salud_v3 %>% 
  dplyr::select(LocaUrbRur,Cotiza,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Salud_v4 <- join_all(list(Salud_v2,Salud_v3), by=c("Localizacion"),type = "full")

# Graficamos:
# Graficamos:
ggplot(Salud_v4, aes(x=Porcentaje,y=Localizacion,fill=Cotiza))+
  geom_col()+
  labs(x="Porcentaje",y="Localización",fill="Afiliación a ARL:")+
  geom_text(aes(label = Porcentaje),position = position_stack(0.5),
            size=4, vjust=0.5, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top")+
  scale_x_continuous(limits=c(0,100))

# Eliminamos intermedios
rm(Salud,Salud_v2,Salud_v3,Salud_v4)          

```

```{r Modulo Recreación}
#### Tema: Participación política-Consolidado ####
# Pregunta data: "${p_040}. ¿Usted participa en alguna de las siguientes organizaciones o instancias de participación?"

Recreacion <- PilotoIndividuos %>%
  dplyr::select(LocaTotal,LocaUrbRur,"${p_040}. ¿Usted participa en alguna de las siguientes organizaciones o instancias de participación?") %>%
  dplyr::rename(RecreacionCol="${p_040}. ¿Usted participa en alguna de las siguientes organizaciones o instancias de participación?") %>%
  dplyr::filter(RecreacionCol!="No sabe",
                RecreacionCol!="Ninguno",
                RecreacionCol!="No responde",
                RecreacionCol!="Juntas administradoras locales - JAL",
                is.na(RecreacionCol)==F)

# Recodificamos categorias: 
Recreacion$RecreacionCol2 <- c("Recreación")

Recreacion <- Recreacion %>% 
  dplyr::mutate(RecreacionCol2=ifelse(RecreacionCol=="Juntas administradoras locales - JAL","Juntas administradoras locales",RecreacionCol2),
                RecreacionCol2=ifelse(RecreacionCol=="Junta de acción comunal - JAC","Junta de acción comunal",RecreacionCol2),
                RecreacionCol2=ifelse(RecreacionCol=="Veedurías ciudadanas","Veedurías ciudadanas",RecreacionCol2),
                RecreacionCol2=ifelse(RecreacionCol=="Clubes del adulto mayor","Clubes del adulto mayor",RecreacionCol2),
                RecreacionCol2=ifelse(RecreacionCol=="Asociaciones de mujeres","Asociaciones de mujeres",RecreacionCol2),
                RecreacionCol2=ifelse(RecreacionCol=="sindicatos","Sindicatos",RecreacionCol2),
                RecreacionCol2=ifelse(RecreacionCol=="COPACOS - Comités de participación comunitaria en salud","COPACOS",RecreacionCol2),
                RecreacionCol2=ifelse(RecreacionCol=="Grupos juveniles","Grupos juveniles",RecreacionCol2),
                RecreacionCol2=ifelse(RecreacionCol=="Asociación de usuarios","Asociación de usuarios",RecreacionCol2),
                RecreacionCol2=ifelse(RecreacionCol=="Otro","Otro",RecreacionCol2),
                RecreacionCol2=ifelse(RecreacionCol=="Asociaciones u organizaciones de carácter ambiental","Asociaciones ambientales",RecreacionCol2),
                RecreacionCol2=ifelse(RecreacionCol=="Asociación de padres de familia","Asociación de padres de familia",RecreacionCol2),
                RecreacionCol2=ifelse(RecreacionCol=="Consejos comunales de presupuesto participativo","Consejos de presupuesto participativo",RecreacionCol2),
                RecreacionCol2=ifelse(RecreacionCol=="Organización de base o concejos comunitarios","Consejos comunitarios",RecreacionCol2),
                RecreacionCol2=ifelse(RecreacionCol=="Organización de victimas","Organización de victimas",RecreacionCol2),
                RecreacionCol2=ifelse(RecreacionCol=="Corporaciones","Corporaciones",RecreacionCol2)
                )


Recreacion_v2 <- Agrupa(Data=Recreacion,
                 Columna=RecreacionCol2)

# Agrupamos como corresponde:
Recreacion_v2 <- AgrupaTotal(Data=Recreacion,Columna=RecreacionCol2)
Recreacion_v3 <- AgrupaUrbRur(Data=Recreacion,Columna=RecreacionCol2)

# Modificamos datas:
Recreacion_v2 <- Recreacion_v2 %>% 
  dplyr::select(LocaTotal,RecreacionCol2,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Recreacion_v3 <- Recreacion_v3 %>% 
  dplyr::select(LocaUrbRur,RecreacionCol2,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Recreacion_v4 <- join_all(list(Recreacion_v2,Recreacion_v3), by=c("Localizacion"),type = "full")

# Graficamos:
ggplot(Recreacion_v4, aes(x=Porcentaje,y=RecreacionCol2,fill=Localizacion))+
  geom_bar(stat="identity", position="dodge")+
  labs(x="Porcentaje",y="Instancias de participación",fill="Localización:")+
  geom_text(aes(label = Porcentaje),position = position_dodge(1),
            size=3, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,85))

# Paso opcional: exportamos data:
write_xlsx(Recreacion_v2, "Ilu18_ParticipaciónV2.xlsx")

# Eliminamos intermedios:
rm(Recreacion,Recreacion_v2,Recreacion_v3,Recreacion_v4)


#### Tema: Hobbies-Consolidado ####
# Preguntas data: 
# "${p_040}. ¿Cuáles son sus hobbies?/...

Hobbies <- PilotoIndividuos %>%
  dplyr::select(.,c(Localizacion,LocaTotal,LocaUrbRur,"${p_040}. ¿Cuáles son sus hobbies?/Bailar",
                    "${p_040}. ¿Cuáles son sus hobbies?/Bricolaje",
                    "${p_040}. ¿Cuáles son sus hobbies?/Cantar",
                    "${p_040}. ¿Cuáles son sus hobbies?/Cocina",
                    "${p_040}. ¿Cuáles son sus hobbies?/Contactar y conversar",
                    "${p_040}. ¿Cuáles son sus hobbies?/Coser",
                    "${p_040}. ¿Cuáles son sus hobbies?/Escribir",
                    "${p_040}. ¿Cuáles son sus hobbies?/Escuchar música",
                    "${p_040}. ¿Cuáles son sus hobbies?/Fotografía",
                    "${p_040}. ¿Cuáles son sus hobbies?/Hacer deporte",
                    "${p_040}. ¿Cuáles son sus hobbies?/Informarse",
                    "${p_040}. ¿Cuáles son sus hobbies?/Jardinería",
                    "${p_040}. ¿Cuáles son sus hobbies?/Juegos de mesa o azar",
                    "${p_040}. ¿Cuáles son sus hobbies?/Leer",
                    "${p_040}. ¿Cuáles son sus hobbies?/Manualidades",
                    "${p_040}. ¿Cuáles son sus hobbies?/Meditación, yoga y relajación.",
                    "${p_040}. ¿Cuáles son sus hobbies?/Ocio electrónico",
                    "${p_040}. ¿Cuáles son sus hobbies?/Pintar",
                    "${p_040}. ¿Cuáles son sus hobbies?/Series o cine",
                    "${p_040}. ¿Cuáles son sus hobbies?/Teatro",
                    "${p_040}. ¿Cuáles son sus hobbies?/Tocar un instrumento",
                    "${p_040}. ¿Cuáles son sus hobbies?/Viajar",
                    "${p_040}. ¿Cuáles son sus hobbies?/Montar a caballo",
                    "${p_040}. ¿Cuáles son sus hobbies?/Juegos infantiles",
                    "${p_040}. ¿Cuáles son sus hobbies?/Reparación de motos"
                    )
                ) %>%
  dplyr::rename(Bailar="${p_040}. ¿Cuáles son sus hobbies?/Bailar",
                Bricolaje="${p_040}. ¿Cuáles son sus hobbies?/Bricolaje",
                Cantar="${p_040}. ¿Cuáles son sus hobbies?/Cantar",
                Cocina="${p_040}. ¿Cuáles son sus hobbies?/Cocina",
                Conversar="${p_040}. ¿Cuáles son sus hobbies?/Contactar y conversar",
                Coser="${p_040}. ¿Cuáles son sus hobbies?/Coser",
                Escribir="${p_040}. ¿Cuáles son sus hobbies?/Escribir",
                "Escuchar Musica"="${p_040}. ¿Cuáles son sus hobbies?/Escuchar música",
                Fotografía="${p_040}. ¿Cuáles son sus hobbies?/Fotografía",
                "Practicar deporte"="${p_040}. ¿Cuáles son sus hobbies?/Hacer deporte",
                Informarse="${p_040}. ¿Cuáles son sus hobbies?/Informarse",
                Jardinería="${p_040}. ¿Cuáles son sus hobbies?/Jardinería",
                "Juegos de azar"="${p_040}. ¿Cuáles son sus hobbies?/Juegos de mesa o azar",
                Leer="${p_040}. ¿Cuáles son sus hobbies?/Leer",
                Manualidades="${p_040}. ¿Cuáles son sus hobbies?/Manualidades",
                Meditacion="${p_040}. ¿Cuáles son sus hobbies?/Meditación, yoga y relajación.",
                "Ocio virtual"="${p_040}. ¿Cuáles son sus hobbies?/Ocio electrónico",
                Pintar="${p_040}. ¿Cuáles son sus hobbies?/Pintar",
                Series="${p_040}. ¿Cuáles son sus hobbies?/Series o cine",
                Teatro="${p_040}. ¿Cuáles son sus hobbies?/Teatro",
                "Tocar instrumento"="${p_040}. ¿Cuáles son sus hobbies?/Tocar un instrumento",
                Viajar="${p_040}. ¿Cuáles son sus hobbies?/Viajar",
                "Montar caballo"="${p_040}. ¿Cuáles son sus hobbies?/Montar a caballo",
                "Juegos infantiles"="${p_040}. ¿Cuáles son sus hobbies?/Juegos infantiles",
                "Reparación de motos"="${p_040}. ¿Cuáles son sus hobbies?/Reparación de motos"
                )

# Volvemos todas las columnas en tipo numéricas:
Hobbies$Bailar <- as.numeric(Hobbies$Bailar)
Hobbies$Bricolaje <- as.numeric(Hobbies$Bricolaje)
Hobbies$Cantar <- as.numeric(Hobbies$Cantar)
Hobbies$Cocina <- as.numeric(Hobbies$Cocina)
Hobbies$Conversar <- as.numeric(Hobbies$Conversar)
Hobbies$Coser <- as.numeric(Hobbies$Coser)
Hobbies$Escribir <- as.numeric(Hobbies$Escribir)
Hobbies$`Escuchar Musica`<- as.numeric(Hobbies$`Escuchar Musica`)
Hobbies$Fotografía <- as.numeric(Hobbies$Fotografía)
Hobbies$`Practicar deporte` <- as.numeric(Hobbies$`Practicar deporte`)
Hobbies$Informarse <- as.numeric(Hobbies$Informarse)
Hobbies$Jardinería <- as.numeric(Hobbies$Jardinería)
Hobbies$`Juegos de azar` <- as.numeric(Hobbies$`Juegos de azar`)
Hobbies$Leer <- as.numeric(Hobbies$Leer)
Hobbies$Manualidades <- as.numeric(Hobbies$Manualidades)
Hobbies$Meditacion <- as.numeric(Hobbies$Meditacion)
Hobbies$`Ocio virtual` <- as.numeric(Hobbies$`Ocio virtual`)
Hobbies$Pintar <- as.numeric(Hobbies$Pintar)
Hobbies$Series <- as.numeric(Hobbies$Series)
Hobbies$Teatro <- as.numeric(Hobbies$Teatro)
Hobbies$`Tocar instrumento` <- as.numeric(Hobbies$`Tocar instrumento`)
Hobbies$Viajar <- as.numeric(Hobbies$Viajar)
Hobbies$`Montar caballo` <- as.numeric(Hobbies$`Montar caballo`)
Hobbies$`Juegos infantiles` <- as.numeric(Hobbies$`Juegos infantiles`)
Hobbies$`Reparación de motos` <- as.numeric(Hobbies$`Reparación de motos`)


# vamos a crear subgrupos por localidad y luego se concatenan. Para esto creamos una función:
# Funcion:
# Esta función usa la data inicial y la localización que queremos usar:
AgrupaInforma <- function(Data,LocalizacionCol,LocalizacionStr){
  
  DataLocaliza <- Data %>% 
  dplyr::filter({{LocalizacionCol}}==LocalizacionStr)

  DataLocaliza_v2 <- data.frame("Localizacion"=c(LocalizacionStr),
                      "Hobbie"=c("Bailar","Bricolaje","Cantar","Cocina","Conversar","Coser","Escribir","Escuchar Musica","Fotografía","Practicar deporte","Informarse","Jardinería","Juegos de azar","Leer","Manualidades","Meditacion","Ocio virtual","Pintar","Series","Teatro","Tocar instrumento","Viajar","Montar caballo","Juegos infantiles","Reparación de motos"),
                      "Subtotal"=colSums(DataLocaliza[,4:28], na.rm=T)
                        )

  DataLocaliza_v2$Total <- sum(DataLocaliza_v2$Subtotal)

  DataLocaliza_v2 <- DataLocaliza_v2 %>% 
  dplyr::mutate(Porcentaje=round((Subtotal/Total)*100,2))

return(DataLocaliza_v2)
}

# Aplicamos la función en cada localización:
Total <- AgrupaInforma(Data=Hobbies,
                          LocalizacionCol=LocaTotal,
                          LocalizacionStr="Total Área de influencia") %>% 
  dplyr::filter(Porcentaje>0)

AreaUrbana <- AgrupaInforma(Data=Hobbies,
                          LocalizacionCol=LocaUrbRur,
                          LocalizacionStr="Área Urbana")%>% 
  dplyr::filter(Porcentaje>0)

AreaRural <- AgrupaInforma(Data=Hobbies,
                          LocalizacionCol=LocaUrbRur,
                          LocalizacionStr="Área Rural")%>% 
  dplyr::filter(Porcentaje>0)

# Concatenamos:
Hobbies_v2 <- join_all(list(Total,AreaUrbana,AreaRural), by=c("Localizacion"),type = "full")

# Gráfico: 
ggplot(Hobbies_v2, aes(x=Porcentaje,y=Hobbie,fill=Localizacion))+
  geom_bar(stat="identity", position="dodge")+
  labs(x="Porcentaje",y="Hobbies",fill="Localización:")+
  geom_text(aes(label = Porcentaje),position = position_dodge(1),
            size=2.3, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="right",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,35))


# Eliminamos intermedios:
rm(Hobbies,Hobbies_v2,AgrupaInforma,Total,AreaRural,AreaUrbana)

```

```{r Modulo Movilidad}
#### Tema: Medio de transporte al centro educativo-Consolidado ####
# Pregunta data: "${p_040}. ¿Qué medio de transporte utiliza predominantemente para dirigirse a su centro educativo?"

Movilidad <- PilotoIndividuos %>%
  dplyr::select(LocaTotal,LocaUrbRur,"${p_040}. ¿Qué medio de transporte utiliza predominantemente para dirigirse a su centro educativo?") %>%
  dplyr::rename(MovilEduca="${p_040}. ¿Qué medio de transporte utiliza predominantemente para dirigirse a su centro educativo?") %>%
  dplyr::filter(is.na(MovilEduca)==F) 

# Agrupamos:
Movilidad_v2 <- AgrupaTotal(Data=Movilidad,
                 Columna=MovilEduca)

Movilidad_v3 <- AgrupaUrbRur(Data=Movilidad,
                 Columna=MovilEduca)

# Modificamos datas:
Movilidad_v2 <- Movilidad_v2 %>% 
  dplyr::select(LocaTotal,MovilEduca,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Movilidad_v3 <- Movilidad_v3 %>% 
  dplyr::select(LocaUrbRur,MovilEduca,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Movilidad_v4 <- join_all(list(Movilidad_v2,Movilidad_v3), by=c("Localizacion"),type = "full")

# Graficamos:
ggplot(Movilidad_v4, aes(x=Porcentaje,y=MovilEduca,fill=Localizacion))+
  geom_bar(stat="identity", position="dodge")+
  labs(x="Porcentaje",y="Medio de transporte al Centro Educativo",fill="Localización:")+
  geom_text(aes(label = Porcentaje),position = position_dodge(1),
            size=3, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,82))

# Eliminamos intermedios:
rm(Movilidad,Movilidad_v2,Movilidad_v3,Movilidad_v4)

#### Tema: Medio de transporte a Recreación-Consolidado ####
# Pregunta data: ${p_040}. ¿Qué medio de transporte utiliza predominantemente para dirigirse a su centro de recreación (para realizar hobbies)?

Movilidad <- PilotoIndividuos %>%
  dplyr::select(LocaTotal,LocaUrbRur,"${p_040}. ¿Qué medio de transporte utiliza predominantemente para dirigirse a su centro de recreación (para realizar hobbies)?") %>%
  dplyr::rename(Movil="${p_040}. ¿Qué medio de transporte utiliza predominantemente para dirigirse a su centro de recreación (para realizar hobbies)?")%>%
  dplyr::filter(Movil!="No responde",
                Movil!="No sabe",
                is.na(Movil)==F)

# Agrupamos:
Movilidad_v2 <- AgrupaTotal(Data=Movilidad,
                 Columna=Movil)

Movilidad_v3 <- AgrupaUrbRur(Data=Movilidad,
                 Columna=Movil)

# Modificamos datas:
Movilidad_v2 <- Movilidad_v2 %>% 
  dplyr::select(LocaTotal,Movil,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Movilidad_v3 <- Movilidad_v3 %>% 
  dplyr::select(LocaUrbRur,Movil,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Movilidad_v4 <- join_all(list(Movilidad_v2,Movilidad_v3), by=c("Localizacion"),type = "full")

# Graficamos:
ggplot(Movilidad_v4, aes(x=Porcentaje,y=Movil,fill=Localizacion))+
  geom_bar(stat="identity", position="dodge")+
  labs(x="Porcentaje",y="Medio de transporte al centro recreativo",fill="Localización:")+
  geom_text(aes(label = Porcentaje),position = position_dodge(1),
            size=3, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,50))

# Eliminamos intermedios:
rm(Movilidad,Movilidad_v2,Movilidad_v3,Movilidad_v4)

#### Tema: Medio de transporte al trabajo-Consolidado ####
# Pregunta data: "${p_040}. ¿Qué medio de transporte utiliza predominantemente para dirigirse al sitio de su empleo principal?"

Movilidad <- PilotoIndividuos %>%
  dplyr::select(.,LocaTotal,LocaUrbRur,"${p_040}. ¿Qué medio de transporte utiliza predominantemente para dirigirse al sitio de su empleo principal?") %>%
  dplyr::rename(Movil="${p_040}. ¿Qué medio de transporte utiliza predominantemente para dirigirse al sitio de su empleo principal?")%>%
  dplyr::filter(Movil!="No responde",
                Movil!="No sabe",
                is.na(Movil)==F)

# Agrupamos:
Movilidad_v2 <- AgrupaTotal(Data=Movilidad,
                 Columna=Movil)

Movilidad_v3 <- AgrupaUrbRur(Data=Movilidad,
                 Columna=Movil)

# Modificamos datas:
Movilidad_v2 <- Movilidad_v2 %>% 
  dplyr::select(LocaTotal,Movil,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Movilidad_v3 <- Movilidad_v3 %>% 
  dplyr::select(LocaUrbRur,Movil,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Movilidad_v4 <- join_all(list(Movilidad_v2,Movilidad_v3), by=c("Localizacion"),type = "full")

# Graficamos:
ggplot(Movilidad_v4, aes(x=Porcentaje,y=Movil,fill=Localizacion))+
  geom_bar(stat="identity", position="dodge")+
  labs(x="Porcentaje",y="Medio de transporte al trabajo",fill="Localización:")+
  geom_text(aes(label = Porcentaje),position = position_dodge(1),
            size=3, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,55))

# Eliminamos intermedios:
rm(Movilidad,Movilidad_v2,Movilidad_v3,Movilidad_v4)

#### Tema: Tiempo en transportarse-Consolidado ####
# Pregunta data: "${p_040}. ¿Cuánto tiempo tarda en llegar a su centro educativo? (minutos)"
# Pregunta data: "${p_040}. ¿Cuánto tiempo tarda en llegar a su centro de recreación (para realizar hobbies)? (minutos)"
# Pregunta data: "${p_040}. ¿Cuánto tiempo tarda en llegar al sitio de su empleo principal? (minutos)"

Movilidad <- PilotoIndividuos %>%
  dplyr::select(.,c(LocaTotal,LocaUrbRur,"${p_040}. ¿Cuánto tiempo tarda en llegar a su centro educativo? (minutos)","${p_040}. ¿Cuánto tiempo tarda en llegar a su centro de recreación (para realizar hobbies)? (minutos)","${p_040}. ¿Cuánto tiempo tarda en llegar al sitio de su empleo principal? (minutos)")) %>%
  dplyr::rename(MovilEduca="${p_040}. ¿Cuánto tiempo tarda en llegar a su centro educativo? (minutos)",MovilRecrea="${p_040}. ¿Cuánto tiempo tarda en llegar a su centro de recreación (para realizar hobbies)? (minutos)",MovilTrabajo="${p_040}. ¿Cuánto tiempo tarda en llegar al sitio de su empleo principal? (minutos)") 

# Transformamos data a tipo numérico
Movilidad$MovilEduca <- as.numeric(Movilidad$MovilEduca)
Movilidad$MovilRecrea <- as.numeric(Movilidad$MovilRecrea)
Movilidad$MovilTrabajo <- as.numeric(Movilidad$MovilTrabajo)

# Creamos funcion para calcular promedios

FunTiempos <- function(LocalizacionVble,
                       MovilVble,
                       DestinoStr){
  
  Tiempo <- Movilidad %>% 
  dplyr::group_by({{LocalizacionVble}})%>%
    dplyr::summarise(
      TiempoCol = round(mean({{MovilVble}},na.rm = TRUE),2)
      )

 Tiempo$Destino <- c(DestinoStr)

 return(Tiempo)
}

# Aplicamos la función:
TiempoEduca_Total <- FunTiempos(LocalizacionVble=LocaTotal,
                       MovilVble=MovilEduca,
                       DestinoStr="Centro educativo") %>% 
  dplyr::rename(Localizacion=LocaTotal)

TiempoRecrea_Total <- FunTiempos(LocalizacionVble=LocaTotal,
                       MovilVble=MovilRecrea,
                       DestinoStr="Centro recreativo")%>% 
  dplyr::rename(Localizacion=LocaTotal)

TiempoLabor_Total <- FunTiempos(LocalizacionVble=LocaTotal,
                       MovilVble=MovilTrabajo,
                       DestinoStr="Sitio laboral")%>% 
  dplyr::rename(Localizacion=LocaTotal)
#
TiempoEduca_Parcial <- FunTiempos(LocalizacionVble=LocaUrbRur,
                       MovilVble=MovilEduca,
                       DestinoStr="Centro educativo") %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

TiempoRecrea_Parcial <- FunTiempos(LocalizacionVble=LocaUrbRur,
                       MovilVble=MovilRecrea,
                       DestinoStr="Centro recreativo")%>% 
  dplyr::rename(Localizacion=LocaUrbRur)

TiempoLabor_Parcial <- FunTiempos(LocalizacionVble=LocaUrbRur,
                       MovilVble=MovilTrabajo,
                       DestinoStr="Sitio laboral")%>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos la data:
Tiempos_Total <- join_all(list(TiempoEduca_Total,TiempoRecrea_Total,TiempoLabor_Total), by=c("Destino"),type = "full")

Tiempos_Parcial <- join_all(list(TiempoEduca_Parcial,
                                 TiempoRecrea_Parcial,
                                 TiempoLabor_Parcial), by=c("Destino"),type = "full")

Tiempos <- join_all(list(Tiempos_Total,
                         Tiempos_Parcial), by=c("Localizacion"),type = "full")

# Graficamos:
ggplot(Tiempos, aes(x=TiempoCol,y=Destino,fill=Localizacion))+
  geom_bar(stat="identity", position="dodge")+
  labs(x="Tiempo en desplazamiento (minutos)",y="Destino",fill="Localización:")+
  geom_text(aes(label = TiempoCol),position = position_dodge(1),
            size=3.4, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,40))

# Eliminamos intermedios:
rm(Movilidad,TiempoEduca_Parcial,TiempoEduca_Total,TiempoLabor_Parcial,TiempoLabor_Total,TiempoRecrea_Parcial,TiempoRecrea_Total,Tiempos,Tiempos_Parcial,Tiempos_Total)

#### Tema: Calificación vías: Educación-Consolidado ####
# Pregunta data: "${p_040}. En su opinión: ¿cuál es el estado de las vías que utiliza para dirigirse a su centro educativo?"

Movilidad <- PilotoIndividuos %>%
  dplyr::select(.,c(LocaTotal,LocaUrbRur,"${p_040}. En su opinión: ¿cuál es el estado de las vías que utiliza para dirigirse a su centro educativo?")) %>%
  dplyr::rename(MovilEduca="${p_040}. En su opinión: ¿cuál es el estado de las vías que utiliza para dirigirse a su centro educativo?") %>%
  dplyr::filter(MovilEduca!="No se encuentra en casa",
                is.na(MovilEduca)==F)

# Agrupamos:
Movilidad_v2 <- AgrupaTotal(Data=Movilidad,
                 Columna=MovilEduca)

Movilidad_v3 <- AgrupaUrbRur(Data=Movilidad,
                 Columna=MovilEduca)

# Modificamos datas:
Movilidad_v2 <- Movilidad_v2 %>% 
  dplyr::select(LocaTotal,MovilEduca,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Movilidad_v3 <- Movilidad_v3 %>% 
  dplyr::select(LocaUrbRur,MovilEduca,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Movilidad_v4 <- join_all(list(Movilidad_v2,Movilidad_v3), by=c("Localizacion"),type = "full")

# Data en factores con orden predeterminado
Movilidad_v4$MovilEduca <- factor(Movilidad_v4$MovilEduca, levels=c("Malo","Regular","Bueno"))

# Graficamos:
ggplot(Movilidad_v4, aes(x=Porcentaje,y=MovilEduca,fill=Localizacion))+
  geom_bar(stat="identity", position="dodge")+
  labs(x="Porcentaje",y="Calificación vías hacía el C. Educativo",fill="Localización:")+
  geom_text(aes(label = Porcentaje),position = position_dodge(1),
            size=4, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,60))

# Eliminamos intermedios:
rm(Movilidad,Movilidad_v2,Movilidad_v3,Movilidad_v4)

#### Tema: Calificación vías: Recreación-Consolidado ####
# Pregunta data: "${p_040}. En su opinión: ¿cuál es el estado de las vías que utiliza para dirigirse a su centro de recreación"
Movilidad <- PilotoIndividuos %>%
  dplyr::select(.,c(LocaTotal,LocaUrbRur,"${p_040}. En su opinión: ¿cuál es el estado de las vías que utiliza para dirigirse a su centro de recreación (para realizar hobbies)?")) %>%
  dplyr::rename(MovilRecrea="${p_040}. En su opinión: ¿cuál es el estado de las vías que utiliza para dirigirse a su centro de recreación (para realizar hobbies)?") %>%
  dplyr::filter(MovilRecrea!="No responde",
                MovilRecrea!="No se encuentra en casa",
                is.na(MovilRecrea)==F)

# Agrupamos:
Movilidad_v2 <- AgrupaTotal(Data=Movilidad,
                 Columna=MovilRecrea)

Movilidad_v3 <- AgrupaUrbRur(Data=Movilidad,
                 Columna=MovilRecrea)

# Modificamos datas:
Movilidad_v2 <- Movilidad_v2 %>% 
  dplyr::select(LocaTotal,MovilRecrea,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Movilidad_v3 <- Movilidad_v3 %>% 
  dplyr::select(LocaUrbRur,MovilRecrea,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Movilidad_v4 <- join_all(list(Movilidad_v2,Movilidad_v3), by=c("Localizacion"),type = "full")

# Data en factores con orden predeterminado
Movilidad_v4$MovilRecrea <- factor(Movilidad_v4$MovilRecrea, levels=c("Malo","Regular","Bueno"))

# Graficamos:
ggplot(Movilidad_v4, aes(x=Porcentaje,y=MovilRecrea,fill=Localizacion))+
  geom_bar(stat="identity", position="dodge")+
  labs(x="Porcentaje",y="Calificación vías hacía el C. Recreativo",fill="Localización:")+
  geom_text(aes(label = Porcentaje),position = position_dodge(1),
            size=4, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,60))

# Eliminamos intermedios:
rm(Movilidad,Movilidad_v2,Movilidad_v3,Movilidad_v4)

#### Tema: Calificación vías: Trabajo-Consolidado ####
# Pregunta data: "${p_040}. En su opinión: ¿cuál es el estado de las vías que utiliza para dirigirse al sitio de su empleo principal?"

Movilidad <- PilotoIndividuos %>%
  dplyr::select(.,c(LocaTotal,LocaUrbRur,"${p_040}. En su opinión: ¿cuál es el estado de las vías que utiliza para dirigirse al sitio de su empleo principal?")) %>%
  dplyr::rename(Movil="${p_040}. En su opinión: ¿cuál es el estado de las vías que utiliza para dirigirse al sitio de su empleo principal?") %>%  dplyr::filter(Movil!="No se encuentra en casa",
                is.na(Movil)==F)

# Agrupamos:
Movilidad_v2 <- AgrupaTotal(Data=Movilidad,
                 Columna=Movil)

Movilidad_v3 <- AgrupaUrbRur(Data=Movilidad,
                 Columna=Movil)

# Modificamos datas:
Movilidad_v2 <- Movilidad_v2 %>% 
  dplyr::select(LocaTotal,Movil,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Movilidad_v3 <- Movilidad_v3 %>% 
  dplyr::select(LocaUrbRur,Movil,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Movilidad_v4 <- join_all(list(Movilidad_v2,Movilidad_v3), by=c("Localizacion"),type = "full")

# Data en factores con orden predeterminado
Movilidad_v4$Movil <- factor(Movilidad_v4$Movil, levels=c("Malo","Regular","Bueno"))

# Graficamos:
ggplot(Movilidad_v4, aes(x=Porcentaje,y=Movil,fill=Localizacion))+
  geom_bar(stat="identity", position="dodge")+
  labs(x="Porcentaje",y="Calificación vías hacía el trabajo",fill="Localización:")+
  geom_text(aes(label = Porcentaje),position = position_dodge(1),
            size=3, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,55))

# Eliminamos intermedios:
rm(Movilidad,Movilidad_v2,Movilidad_v3,Movilidad_v4)
```

```{r Modulo Laboral e ingresos}
#### Tema: Actividad semana pasada-Consolidado ####
# Pregunta data: "${p_040}. ¿En qué actividad ocupó la mayor parte del tiempo la semana pasada? [la predominante]"

Actividad <- PilotoIndividuos %>%
  dplyr::select(LocaTotal,LocaUrbRur,"${p_040}. ¿En qué actividad ocupó la mayor parte del tiempo la semana pasada? [la predominante]") %>%
  dplyr::rename(ActividadCol="${p_040}. ¿En qué actividad ocupó la mayor parte del tiempo la semana pasada? [la predominante]") %>%  dplyr::filter(ActividadCol!="No responde",
                is.na(ActividadCol)==F) 

# Agrupamos:
Actividad_v2 <- AgrupaTotal(Data=Actividad,
                 Columna=ActividadCol)

Actividad_v3 <- AgrupaUrbRur(Data=Actividad,
                 Columna=ActividadCol)

# Modificamos datas:
Actividad_v2 <- Actividad_v2 %>% 
  dplyr::select(LocaTotal,ActividadCol,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Actividad_v3 <- Actividad_v3 %>% 
  dplyr::select(LocaUrbRur,ActividadCol,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Actividad_v4 <- join_all(list(Actividad_v2,Actividad_v3), by=c("Localizacion"),type = "full")

# Graficamos:
ggplot(Actividad_v4, aes(x=Porcentaje,y=ActividadCol,fill=Localizacion))+
  geom_bar(stat="identity", position="dodge")+
  labs(x="Porcentaje",y="Actividad en última semana",fill="Localización:")+
  geom_text(aes(label = Porcentaje),position = position_dodge(1),
            size=3, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,50))

# Eliminamos intermedios:
rm(Actividad,Actividad_v2,Actividad_v3,Actividad_v4)

#### Tema: Sector económico empresa-Consolidado ####
# Pregunta data: "${p_040}. ¿En qué actividad ocupó la mayor parte del tiempo la semana pasada? [la predominante]"
# Pregunta data: "${p_040}. ¿A qué actividad específica se dedica principalmente la empresa o negocio en la que realiza su trabajo?"

Actividad <- PilotoIndividuos %>%
  dplyr::select(.,c(LocaTotal,LocaUrbRur,"${p_040}. ¿A qué actividad específica se dedica principalmente la empresa o negocio en la que realiza su trabajo?")) %>%
  dplyr::rename(Sector="${p_040}. ¿A qué actividad específica se dedica principalmente la empresa o negocio en la que realiza su trabajo?") %>% 
  dplyr::filter(is.na(Sector)==F,
                Sector!="No responde") 

# Recodificamos variables:
Actividad$SectorShort <- c("Sector")

Actividad <- Actividad %>% 
  dplyr::mutate(SectorShort=ifelse(Sector=="A-Agricultura, Ganadería, Caza, Silvicultura y Pesca","A-Agricultura",SectorShort),
                SectorShort=ifelse(Sector=="C-Industrias manufactureras","C-Industrias manufactureras",SectorShort),
                SectorShort=ifelse(Sector=="H-Transporte y almacenamiento","H-Transporte y almacenamiento",SectorShort),
                SectorShort=ifelse(Sector=="G-Comercio al por mayor y por menor; reparación de vehículos y motos","G-Comercio",SectorShort),
                SectorShort=ifelse(Sector=="T-Actividades de hogares individuales.","T-Actividades de hogares",SectorShort),
                SectorShort=ifelse(Sector=="F-Construcción","F-Construcción",SectorShort),
                SectorShort=ifelse(Sector=="P-Educación","P-Educación",SectorShort),
                SectorShort=ifelse(Sector=="Q-Actividades de atención de la salud humana y asistencia social","Q-Salud humana y asistencia social",SectorShort),
                SectorShort=ifelse(Sector=="S-Otras actividades de servicios","S-Otros servicios",SectorShort),
                SectorShort=ifelse(Sector=="J-Información y comunicaciones","J-Información y comunicaciones",SectorShort),
                SectorShort=ifelse(Sector=="N-Actividades de servicio administrativo y de apoyo","N-Actividades administrativas y de apoyo",SectorShort),
                SectorShort=ifelse(Sector=="I-Alojamiento y servicios de comida","I-Alojamiento y comida",SectorShort),
                SectorShort=ifelse(Sector=="R-Actividades Artisticas, de entretenimiento y recreación.","R-Actividades Artisticas y recreación",SectorShort),
                SectorShort=ifelse(Sector=="K-Actividades financieras y de seguros","K-Actividades financieras",SectorShort),
                SectorShort=ifelse(Sector=="B-Explotación de Minas y canteras","B-Explotación de Minas",SectorShort),
                SectorShort=ifelse(Sector=="M-Actividades profesionales, científicas y técnicas","M-Actividades profesionales",SectorShort),
                SectorShort=ifelse(Sector=="D-Suministro de electricidad, gas, vapor y aire acondicionado","D-Suministro de electricidad",SectorShort),
                SectorShort=ifelse(Sector=="E-Distribución de agua, evacuación y tratamiento de residuos; gestión de desechos y saneamiento","E-Distribución de agua",SectorShort),
                SectorShort=ifelse(Sector=="O-Administración pública y defensa","O-Administración pública",SectorShort),
                SectorShort=ifelse(Sector=="L-Actividades inmobiliarias","L-Actividades inmobiliarias",SectorShort),
                )

# Agrupamos:
Actividad_v2 <- AgrupaTotal(Data=Actividad,
                 Columna=SectorShort)

Actividad_v3 <- AgrupaUrbRur(Data=Actividad,
                 Columna=SectorShort)

# Modificamos datas:
Actividad_v2 <- Actividad_v2 %>% 
  dplyr::select(LocaTotal,SectorShort,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Actividad_v3 <- Actividad_v3 %>% 
  dplyr::select(LocaUrbRur,SectorShort,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Actividad_v4 <- join_all(list(Actividad_v2,Actividad_v3), by=c("Localizacion"),type = "full")

# Graficamos:
ggplot(Actividad_v4, aes(x=Porcentaje,y=SectorShort,fill=Localizacion))+
  geom_bar(stat="identity", position="dodge")+
  labs(x="Porcentaje",y="Sector económico del empleo",fill="Localización:")+
  geom_text(aes(label = Porcentaje),position = position_dodge(1),
            size=2.8, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,82))

# Eliminamos intermedios:
rm(Actividad,Actividad_v2,Actividad_v3,Actividad_v4)

#### Tema: Posición ocupacional-Consolidado ####
# Pregunta data: "${p_040}. ¿En qué actividad ocupó la mayor parte del tiempo la semana pasada? [la predominante]"
# Pregunta data: "${p_040}. En este trabajo es:"

Actividad <- PilotoIndividuos %>%
  dplyr::select(.,c(LocaTotal,LocaUrbRur,"${p_040}. En este trabajo es:")) %>%
  dplyr::rename(Posicion="${p_040}. En este trabajo es:")%>% 
  dplyr::filter(Posicion!="No sabe",
                Posicion!="No responde",
                is.na(Posicion)==F)  

# Agrupamos:
Actividad_v2 <- AgrupaTotal(Data=Actividad,
                 Columna=Posicion)

Actividad_v3 <- AgrupaUrbRur(Data=Actividad,
                 Columna=Posicion)

# Modificamos datas:
Actividad_v2 <- Actividad_v2 %>% 
  dplyr::select(LocaTotal,Posicion,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Actividad_v3 <- Actividad_v3 %>% 
  dplyr::select(LocaUrbRur,Posicion,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Actividad_v4 <- join_all(list(Actividad_v2,Actividad_v3), by=c("Localizacion"),type = "full")

# Graficamos:
ggplot(Actividad_v4, aes(x=Porcentaje,y=Posicion,fill=Localizacion))+
  geom_bar(stat="identity", position="dodge")+
  labs(x="Porcentaje",y="Posición ocupacional",fill="Localización:")+
  geom_text(aes(label = Porcentaje),position = position_dodge(1),
            size=3.5, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,65))

# Eliminamos intermedios:
rm(Actividad,Actividad_v2,Actividad_v3,Actividad_v4)

#### Tema: Horas en su empleo-Consolidado ####
# Pregunta data: "${p_040}. ¿En qué actividad ocupó la mayor parte del tiempo la semana pasada? [la predominante]"
# Pregunta data: "${p_040}. ¿Cuántas horas a la semana trabaja normalmente en ese trabajo principal?"

Actividad <- PilotoIndividuos %>%
  dplyr::select(.,c(LocaTotal,LocaUrbRur,"${p_040}. ¿Cuántas horas a la semana trabaja normalmente en ese trabajo principal?")) %>%
  dplyr::rename(Horas="${p_040}. ¿Cuántas horas a la semana trabaja normalmente en ese trabajo principal?")%>% 
  dplyr::filter(is.na(Horas)==F,
                Horas>0) # eliminamos valores negativos

# Transformamos data a tipo numérico
Actividad$Horas <- as.numeric(Actividad$Horas)

# Creamos DF: con promedios de tiempo por localización:

Tiempos <- Actividad %>% 
  dplyr::group_by(Localizacion)%>%
    dplyr::summarise(
      Tiempo = round(mean(Horas,na.rm = TRUE),2)
      )

# Encontramos promedios de Horas por localización:

# Total Area:
Actividad_v2 <- Actividad %>% 
  dplyr::group_by(LocaTotal)%>%
    dplyr::summarise(
      HorasCol = round(mean(Horas,na.rm = TRUE),2)
      ) %>% 
  dplyr::rename(Localizacion=LocaTotal)

# Por Area :
Actividad_v3 <- Actividad %>% 
  dplyr::group_by(LocaUrbRur)%>%
    dplyr::summarise(
      HorasCol = round(mean(Horas,na.rm = TRUE),2)
      ) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Actividad_v4 <- join_all(list(Actividad_v2,Actividad_v3), by=c("Localizacion"),type = "full")

# Graficamos:
ggplot(Actividad_v4, aes(x=HorasCol,y=Localizacion))+
  geom_bar(stat="identity", position="dodge",fill="cyan4")+
  labs(x="Horas (promedio) por semana",y="Localización")+
  geom_text(aes(label = HorasCol),position = position_dodge(1),
            size=4, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,55))

# Eliminamos intermedios:
rm(Actividad,Actividad_v2,Actividad_v3,Actividad_v4)

#### Tema: Tiene Contrato-Consolidado ####
# Pregunta data: "${p_040}. ¿En qué actividad ocupó la mayor parte del tiempo la semana pasada? [la predominante]"
# Pregunta data: "${p_040}. ¿Para realizar este trabajo tiene algún contrato?"

Actividad <- PilotoIndividuos %>%
  dplyr::select(.,c(LocaTotal,LocaUrbRur,"${p_040}. ¿Para realizar este trabajo tiene algún contrato?")) %>%
  dplyr::rename(Contrato="${p_040}. ¿Para realizar este trabajo tiene algún contrato?")%>% 
  dplyr::filter(Contrato!="No responde",
                Contrato!="No sabe",
                is.na(Contrato)==F)  

# Agrupamos:
Actividad_v2 <- AgrupaTotal(Data=Actividad,
                 Columna=Contrato)

Actividad_v3 <- AgrupaUrbRur(Data=Actividad,
                 Columna=Contrato)

# Modificamos datas:
Actividad_v2 <- Actividad_v2 %>% 
  dplyr::select(LocaTotal,Contrato,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Actividad_v3 <- Actividad_v3 %>% 
  dplyr::select(LocaUrbRur,Contrato,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Actividad_v4 <- join_all(list(Actividad_v2,Actividad_v3), by=c("Localizacion"),type = "full")

# Graficamos:
ggplot(Actividad_v4, aes(x=Porcentaje,y=Localizacion,fill=Contrato))+
  geom_col()+
  labs(x="Porcentaje",y="Localización",fill="Tiene contrato laboral:")+
  geom_text(aes(label = Porcentaje),position = position_stack(0.5),
            size=4, vjust=0.5, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top")+
  scale_x_continuous(limits=c(0,100))

# Eliminamos intermedios
rm(Actividad,Actividad_v2,Actividad_v3,Actividad_v4)

#### Tema: Ingresos laborales-Consolidado ####
# Pregunta data: "${p_040}. ¿Cuánto ganó el mes pasado en este empleo? o ¿Cuánto recibio el mes pasado por concepto de trabajo?"
# Atención a esta variable: es suceptible a errores de tipeo

Actividad <- PilotoIndividuos %>%
  dplyr::select(.,c(LocaTotal,LocaUrbRur,"${p_040}. ¿Cuánto ganó el mes pasado en este empleo? o ¿Cuánto recibio el mes pasado por concepto de trabajo?")) %>%
  dplyr::rename(Ingresos="${p_040}. ¿Cuánto ganó el mes pasado en este empleo? o ¿Cuánto recibio el mes pasado por concepto de trabajo?")%>% 
  dplyr::filter(is.na(Ingresos)==F,
                Ingresos>0) # eliminamos valores negativos 

# Transformamos data a tipo numérico
Actividad$Ingresos <- as.numeric(Actividad$Ingresos)

# Encontramos promedios de Ingresos por localización:

# Total Area:
Actividad_v2 <- Actividad %>% 
  dplyr::group_by(LocaTotal)%>%
    dplyr::summarise(
      IngresosCol = round(mean(Ingresos,na.rm = TRUE),0)
      ) %>% 
  dplyr::rename(Localizacion=LocaTotal)

# Por Area :
Actividad_v3 <- Actividad %>% 
  dplyr::group_by(LocaUrbRur)%>%
    dplyr::summarise(
      IngresosCol = round(mean(Ingresos,na.rm = TRUE),0)
      ) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Actividad_v4 <- join_all(list(Actividad_v2,Actividad_v3), by=c("Localizacion"),type = "full")

# Graficamos:
ggplot(Actividad_v4, aes(x=IngresosCol,y=Localizacion))+
  geom_bar(stat="identity", position="dodge",fill="cyan4")+
  labs(x="Ingreso laboral mensual",y="Localización")+
  geom_text(aes(label = IngresosCol),position = position_dodge(1),
            size=4, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,1100000))

# Eliminamos intermedios:
rm(Actividad,Actividad_v2,Actividad_v3,Actividad_v4)

#### Tema: Intereses laborales a futuro V1-Consolidado ####

# Pregunta data: "${p_040}. ¿Cuáles son sus intereses laborales a futuro? (¿Qué le gustaría hacer?)"

Actividad <- PilotoIndividuos %>%
  dplyr::select(LocaTotal,LocaUrbRur,"${p_040}. ¿Cuáles son sus intereses laborales a futuro? (¿Qué le gustaría hacer?)") %>%
  dplyr::rename(InteresLaboral="${p_040}. ¿Cuáles son sus intereses laborales a futuro? (¿Qué le gustaría hacer?)")%>% 
  dplyr::filter(is.na(InteresLaboral)==F,
                InteresLaboral!="No responde",
                InteresLaboral!="No sabe",
                InteresLaboral!="Otro")

# Agrupamos:
Actividad_v2 <- AgrupaTotal(Data=Actividad,
                 Columna=InteresLaboral)

Actividad_v3 <- AgrupaUrbRur(Data=Actividad,
                 Columna=InteresLaboral)

# Modificamos datas:
Actividad_v2 <- Actividad_v2 %>% 
  dplyr::select(LocaTotal,InteresLaboral,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Actividad_v3 <- Actividad_v3 %>% 
  dplyr::select(LocaUrbRur,InteresLaboral,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Actividad_v4 <- join_all(list(Actividad_v2,Actividad_v3), by=c("Localizacion"),type = "full")

# Graficamos:
ggplot(Actividad_v4, aes(x=Porcentaje,y=InteresLaboral,fill=Localizacion))+
  geom_bar(stat="identity", position="dodge")+
  labs(x="Porcentaje",y="Interés laboral a futuro",fill="Localización:")+
  geom_text(aes(label = Porcentaje),position = position_dodge(1),
            size=3.5, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,55))

# Eliminamos intermedios:
rm(Actividad,Actividad_v2,Actividad_v3,Actividad_v4)

#### Tema: Oficios-Consolidado ####
# Preguntas data: 
# "${p_040}. En general, ¿qué oficio sabe hacer?/...

Oficio <- PilotoIndividuos %>%
  dplyr::select(.,c(LocaTotal,LocaUrbRur,
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Agricultor",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Albañil",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Animador",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Artesano",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Barbero",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Barrendero",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Cajero",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Carnicero",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Carpintero",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Cerrajero",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Chofer o conductor",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Cocinero",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/deshollinador",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Editor",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Escritor",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Escultor",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Exterminador",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Fontanero o plomero",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Impresor",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Lavandero",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Lechero",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Leñador",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Locutor",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Mecánico",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Obrero",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Panadero",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Pastor ganadero",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Peletero",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Peluquero",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Pescador",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Pintor",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Policía",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Repartidor",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Sastre",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Soldador",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Tornero",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Vendedor",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Vigilante",
                    "${p_040}. En general, ¿qué oficio sabe hacer?/Manualidades"
                    )) %>%
  dplyr::rename(Agricultor="${p_040}. En general, ¿qué oficio sabe hacer?/Agricultor",
                "Albañil"="${p_040}. En general, ¿qué oficio sabe hacer?/Albañil",
                Animador="${p_040}. En general, ¿qué oficio sabe hacer?/Animador",
                Artesano="${p_040}. En general, ¿qué oficio sabe hacer?/Artesano",
                Barbero="${p_040}. En general, ¿qué oficio sabe hacer?/Barbero",
                Barrendero="${p_040}. En general, ¿qué oficio sabe hacer?/Barrendero",
                Cajero="${p_040}. En general, ¿qué oficio sabe hacer?/Cajero",
                Carnicero="${p_040}. En general, ¿qué oficio sabe hacer?/Carnicero",
                Carpintero="${p_040}. En general, ¿qué oficio sabe hacer?/Carpintero",
                Cerrajero="${p_040}. En general, ¿qué oficio sabe hacer?/Cerrajero",
                Conductor="${p_040}. En general, ¿qué oficio sabe hacer?/Chofer o conductor",
                Cocinero="${p_040}. En general, ¿qué oficio sabe hacer?/Cocinero",
                Deshollinador="${p_040}. En general, ¿qué oficio sabe hacer?/deshollinador",
                Editor="${p_040}. En general, ¿qué oficio sabe hacer?/Editor",
                Escritor="${p_040}. En general, ¿qué oficio sabe hacer?/Escritor",
                Escultor="${p_040}. En general, ¿qué oficio sabe hacer?/Escultor",
                Exterminador="${p_040}. En general, ¿qué oficio sabe hacer?/Exterminador",
                Plomero="${p_040}. En general, ¿qué oficio sabe hacer?/Fontanero o plomero",
                Impresor="${p_040}. En general, ¿qué oficio sabe hacer?/Impresor",
                Lavandero="${p_040}. En general, ¿qué oficio sabe hacer?/Lavandero",
                Lechero="${p_040}. En general, ¿qué oficio sabe hacer?/Lechero",
                "Leñador"="${p_040}. En general, ¿qué oficio sabe hacer?/Leñador",
                Locutor="${p_040}. En general, ¿qué oficio sabe hacer?/Locutor",
                "Mecánico"="${p_040}. En general, ¿qué oficio sabe hacer?/Mecánico",
                Obrero="${p_040}. En general, ¿qué oficio sabe hacer?/Obrero",
                Panadero="${p_040}. En general, ¿qué oficio sabe hacer?/Panadero",
                "Pastor ganadero"="${p_040}. En general, ¿qué oficio sabe hacer?/Pastor ganadero",
                Peletero="${p_040}. En general, ¿qué oficio sabe hacer?/Peletero",
                Peluquero="${p_040}. En general, ¿qué oficio sabe hacer?/Peluquero",
                Pescador="${p_040}. En general, ¿qué oficio sabe hacer?/Pescador",
                Pintor="${p_040}. En general, ¿qué oficio sabe hacer?/Pintor",
                Policia="${p_040}. En general, ¿qué oficio sabe hacer?/Policía",
                Repartidor="${p_040}. En general, ¿qué oficio sabe hacer?/Repartidor",
                Sastre="${p_040}. En general, ¿qué oficio sabe hacer?/Sastre",
                Soldador="${p_040}. En general, ¿qué oficio sabe hacer?/Soldador",
                Tornero="${p_040}. En general, ¿qué oficio sabe hacer?/Tornero",
                Vendedor="${p_040}. En general, ¿qué oficio sabe hacer?/Vendedor",
                Vigilante="${p_040}. En general, ¿qué oficio sabe hacer?/Vigilante",
                Manualidades="${p_040}. En general, ¿qué oficio sabe hacer?/Manualidades"
                )

# Volvemos todas las columnaas en tipo numéricas:
Oficio$Agricultor <- as.numeric(Oficio$Agricultor)
Oficio$Albañil <- as.numeric(Oficio$Albañil)
Oficio$Animador <- as.numeric(Oficio$Animador)
Oficio$Artesano <- as.numeric(Oficio$Artesano)
Oficio$Barbero <- as.numeric(Oficio$Barbero)
Oficio$Barrendero <- as.numeric(Oficio$Barrendero)
Oficio$Cajero <- as.numeric(Oficio$Cajero)
Oficio$Carnicero <- as.numeric(Oficio$Carnicero)
Oficio$Carpintero <- as.numeric(Oficio$Carpintero)
Oficio$Cerrajero <- as.numeric(Oficio$Cerrajero)
Oficio$Conductor <- as.numeric(Oficio$Conductor)
Oficio$Cocinero <- as.numeric(Oficio$Cocinero)
Oficio$Deshollinador <- as.numeric(Oficio$Deshollinador)
Oficio$Editor <- as.numeric(Oficio$Editor)
Oficio$Escritor <- as.numeric(Oficio$Escritor)
Oficio$Escultor <- as.numeric(Oficio$Escultor)
Oficio$Exterminador <- as.numeric(Oficio$Exterminador)
Oficio$Plomero <- as.numeric(Oficio$Plomero)
Oficio$Impresor <- as.numeric(Oficio$Impresor)
Oficio$Lavandero <- as.numeric(Oficio$Lavandero)
Oficio$Lechero <- as.numeric(Oficio$Lechero)
Oficio$Leñador <- as.numeric(Oficio$Leñador)
Oficio$Locutor <- as.numeric(Oficio$Locutor)
Oficio$Mecánico <- as.numeric(Oficio$Mecánico)
Oficio$Obrero <- as.numeric(Oficio$Obrero)
Oficio$Panadero <- as.numeric(Oficio$Panadero)
Oficio$`Pastor ganadero` <- as.numeric(Oficio$`Pastor ganadero`)
Oficio$Peletero <- as.numeric(Oficio$Peletero)
Oficio$Peluquero <- as.numeric(Oficio$Peluquero)
Oficio$Pescador <- as.numeric(Oficio$Pescador)
Oficio$Pintor <- as.numeric(Oficio$Pintor)
Oficio$Policia <- as.numeric(Oficio$Policia)
Oficio$Repartidor <- as.numeric(Oficio$Repartidor)
Oficio$Sastre <- as.numeric(Oficio$Sastre)
Oficio$Soldador <- as.numeric(Oficio$Soldador)
Oficio$Tornero <- as.numeric(Oficio$Tornero)
Oficio$Vendedor <- as.numeric(Oficio$Vendedor)
Oficio$Vigilante <- as.numeric(Oficio$Vigilante)
Oficio$Manualidades <- as.numeric(Oficio$Manualidades)

# vamos a crear subgrupos por localidad y luego se concatenan. Para esto creamos una función:
# Funcion:
# Esta función usa la data inicial y la localización que queremos usar:
AgrupaInforma <- function(Data,
                          LocalizacionCol,
                          LocalizacionStr){
  
  DataLocaliza <- Data %>% 
  dplyr::filter({{LocalizacionCol}}==LocalizacionStr)

  DataLocaliza_v2 <- data.frame("Localizacion"=c(LocalizacionStr),
                      "Oficio"=c("Agricultor","Albañil","Animador","Artesano","Barbero","Barrendero","Cajero","Carnicero","Carpintero","Cerrajero","Conductor","Cocinero","Deshollinador","Editor","Escritor","Escultor","Exterminador","Plomero","Impresor","Lavandero","Lechero","Leñador","Locutor","Mecánico","Obrero","Panadero","Pastor ganadero","Peletero","Peluquero","Pescador","Pintor","Policía","Repartidor","Sastre","Soldador","Tornero","Vendedor","Vigilante","Manualidades"),
                      "Subtotal"=colSums(DataLocaliza[,3:41], na.rm=T)
                        )

  DataLocaliza_v2$Total <- sum(DataLocaliza_v2$Subtotal)

  DataLocaliza_v2 <- DataLocaliza_v2 %>% 
  dplyr::mutate(Porcentaje=round((Subtotal/Total)*100,2))

return(DataLocaliza_v2)
}

# Aplicamos la función en cada localización:
Total <- AgrupaInforma(Data=Oficio,
                          LocalizacionCol=LocaTotal,
                          LocalizacionStr="Total Área de influencia") %>% 
  dplyr::filter(Porcentaje>0)

AreaUrbana <- AgrupaInforma(Data=Oficio,
                          LocalizacionCol=LocaUrbRur,
                          LocalizacionStr="Área Urbana")%>% 
  dplyr::filter(Porcentaje>0)

AreaRural <- AgrupaInforma(Data=Oficio,
                          LocalizacionCol=LocaUrbRur,
                          LocalizacionStr="Área Rural")%>% 
  dplyr::filter(Porcentaje>0)

# Concatenamos:
Oficio_v2 <- join_all(list(Total,AreaUrbana,AreaRural), by=c("Localizacion"),type = "full")

# Gráfico: 
ggplot(Oficio_v2, aes(x=Porcentaje,y=Oficio,fill=Localizacion))+
  geom_bar(stat="identity", position="dodge")+
  labs(x="Porcentaje",y="Oficio",fill="Localización:")+
  geom_text(aes(label = Porcentaje),position = position_dodge(1),
            size=2.3, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="right",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,75))


# Eliminamos intermedios:
rm(Oficio,Oficio_v2,AgrupaInforma,Total,AreaRural,AreaUrbana)
```

```{r Modulo Proyectos productivos}
#### Tema: Tiene proyecto productivo-Consolidado ####
# Pregunta data: "¿Tiene este hogar algún tipo de negocio?"

Actividad <- PilotoHogares %>%
  dplyr::select(LocaTotal,LocaUrbRur,"¿Tiene este hogar algún tipo de negocio?") %>%
  dplyr::rename(ProyectoCol="¿Tiene este hogar algún tipo de negocio?")%>%  dplyr::filter(ProyectoCol!="No responde",
                        is.na(ProyectoCol)==F) 


# Agrupamos:
Actividad_v2 <- AgrupaTotal(Data=Actividad,
                 Columna=ProyectoCol)

Actividad_v3 <- AgrupaUrbRur(Data=Actividad,
                 Columna=ProyectoCol)

# Modificamos datas:
Actividad_v2 <- Actividad_v2 %>% 
  dplyr::select(LocaTotal,ProyectoCol,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Actividad_v3 <- Actividad_v3 %>% 
  dplyr::select(LocaUrbRur,ProyectoCol,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Actividad_v4 <- join_all(list(Actividad_v2,Actividad_v3), by=c("Localizacion"),type = "full")

# Graficamos:
ggplot(Actividad_v4, aes(x=Porcentaje,y=Localizacion,fill=ProyectoCol))+
  geom_col()+
  labs(x="Porcentaje",y="Localización",fill="Proyectos productivos en el hogar:")+
  geom_text(aes(label = Porcentaje),position = position_stack(0.5),
            size=4, vjust=0.5, hjust=0.5 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top")+
  scale_x_continuous(limits=c(0,100))

# Eliminamos intermedios
rm(Actividad,Actividad_v2,Actividad_v3,Actividad_v4)


#### Tema: Sector económico del proyecto-Consolidado ####
# Pregunta data: "¿Cuál es la actividad económica del negocio?"

Actividad <- PilotoProyectos %>%
  dplyr::select(LocaTotal,LocaUrbRur,"¿Cuál es la actividad económica del negocio?") %>%
  dplyr::rename(Sector="¿Cuál es la actividad económica del negocio?") %>% 
  dplyr::filter(Sector!="No responde")

# Recodificamos variables:
Actividad$SectorShort <- c("Sector")

Actividad <- Actividad %>% 
  dplyr::mutate(SectorShort=ifelse(Sector=="A-Agricultura, Ganadería, Caza, Silvicultura y Pesca","A-Agricultura",SectorShort),
                SectorShort=ifelse(Sector=="C-Industrias manufactureras","C-Industrias manufactureras",SectorShort),
                SectorShort=ifelse(Sector=="H-Transporte y almacenamiento","H-Transporte y almacenamiento",SectorShort),
                SectorShort=ifelse(Sector=="G-Comercio al por mayor y por menor; reparación de vehículos y motos","G-Comercio",SectorShort),
                SectorShort=ifelse(Sector=="T-Actividades de hogares individuales.","T-Actividades de hogares",SectorShort),
                SectorShort=ifelse(Sector=="F-Construcción","F-Construcción",SectorShort),
                SectorShort=ifelse(Sector=="P-Educación","P-Educación",SectorShort),
                SectorShort=ifelse(Sector=="Q-Actividades de atención de la salud humana y asistencia social","Q-Salud humana y asistencia social",SectorShort),
                SectorShort=ifelse(Sector=="S-Otras actividades de servicios","S-Otros servicios",SectorShort),
                SectorShort=ifelse(Sector=="J-Información y comunicaciones","J-Información y comunicaciones",SectorShort),
                SectorShort=ifelse(Sector=="N-Actividades de servicio administrativo y de apoyo","N-Actividades administrativas y de apoyo",SectorShort),
                SectorShort=ifelse(Sector=="I-Alojamiento y servicios de comida","I-Alojamiento y comida",SectorShort),
                SectorShort=ifelse(Sector=="R-Actividades Artisticas, de entretenimiento y recreación.","R-Actividades Artisticas y recreación",SectorShort),
                SectorShort=ifelse(Sector=="K-Actividades financieras y de seguros","K-Actividades financieras",SectorShort),
                SectorShort=ifelse(Sector=="B-Explotación de Minas y canteras","B-Explotación de Minas",SectorShort),
                SectorShort=ifelse(Sector=="M-Actividades profesionales, científicas y técnicas","M-Actividades profesionales",SectorShort),
                SectorShort=ifelse(Sector=="D-Suministro de electricidad, gas, vapor y aire acondicionado","D-Suministro de electricidad",SectorShort),
                SectorShort=ifelse(Sector=="E-Distribución de agua, evacuación y tratamiento de residuos; gestión de desechos y saneamiento","E-Distribución de agua",SectorShort),
                SectorShort=ifelse(Sector=="O-Administración pública y defensa","O-Administración pública",SectorShort),
                SectorShort=ifelse(Sector=="L-Actividades inmobiliarias","L-Actividades inmobiliarias",SectorShort)
                )

# Agrupamos:
Actividad_v2 <- AgrupaTotal(Data=Actividad,
                 Columna=SectorShort)

Actividad_v3 <- AgrupaUrbRur(Data=Actividad,
                 Columna=SectorShort)

# Modificamos datas:
Actividad_v2 <- Actividad_v2 %>% 
  dplyr::select(LocaTotal,SectorShort,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Actividad_v3 <- Actividad_v3 %>% 
  dplyr::select(LocaUrbRur,SectorShort,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Actividad_v4 <- join_all(list(Actividad_v2,Actividad_v3), by=c("Localizacion"),type = "full")

# Graficamos:
ggplot(Actividad_v4, aes(x=Porcentaje,y=SectorShort,fill=Localizacion))+
  geom_bar(stat="identity", position="dodge")+
  labs(x="Porcentaje",y="Sector económico del proyecto productivo",fill="Localización:")+
  geom_text(aes(label = Porcentaje),position = position_dodge(1),
            size=3.5, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,60))

# Eliminamos intermedios:
rm(Actividad,Actividad_v2,Actividad_v3,Actividad_v4)

#### Tema: Inscrito en CC-Consolidado ####
# Pregunta data: "¿Está inscrito en Cámara de Comercio?"

Actividad <- PilotoProyectos %>%
  dplyr::select(LocaTotal,LocaUrbRur,"¿Está inscrito en Cámara de Comercio?") %>%
  dplyr::rename(Inscripcion="¿Está inscrito en Cámara de Comercio?") %>% 
  dplyr::filter(Inscripcion!="No sabe")

# Agrupamos:
Actividad_v2 <- AgrupaTotal(Data=Actividad,
                 Columna=Inscripcion)

Actividad_v3 <- AgrupaUrbRur(Data=Actividad,
                 Columna=Inscripcion)

# Modificamos datas:
Actividad_v2 <- Actividad_v2 %>% 
  dplyr::select(LocaTotal,Inscripcion,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Actividad_v3 <- Actividad_v3 %>% 
  dplyr::select(LocaUrbRur,Inscripcion,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Actividad_v4 <- join_all(list(Actividad_v2,Actividad_v3), by=c("Localizacion"),type = "full")

# Graficamos:
ggplot(Actividad_v4, aes(x=Porcentaje,y=Localizacion,fill=Inscripcion))+
  geom_col()+
  labs(x="Porcentaje",y="Localización",fill="Inscripción en Cámara de Comercio:")+
  geom_text(aes(label = Porcentaje),position = position_stack(0.5),
            size=4, vjust=0.5, hjust=0.5 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top")+
  scale_x_continuous(limits=c(0,100))

# Eliminamos intermedios
rm(Actividad,Actividad_v2,Actividad_v3,Actividad_v4)

# Eliminamos intermedios:
rm(Actividad,Actividad_v2)

#### Tema: Tiene RUT-Consolidado ####
# Pregunta data: "¿Tiene Rut?"

Actividad <- PilotoProyectos %>%
  dplyr::select(LocaTotal,LocaUrbRur,"¿Tiene Rut?") %>%
  dplyr::rename(Inscripcion="¿Tiene Rut?") %>% 
  dplyr::filter(Inscripcion!="No sabe")

# Agrupamos:
Actividad_v2 <- AgrupaTotal(Data=Actividad,
                 Columna=Inscripcion)

Actividad_v3 <- AgrupaUrbRur(Data=Actividad,
                 Columna=Inscripcion)

# Modificamos datas:
Actividad_v2 <- Actividad_v2 %>% 
  dplyr::select(LocaTotal,Inscripcion,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaTotal)

Actividad_v3 <- Actividad_v3 %>% 
  dplyr::select(LocaUrbRur,Inscripcion,Porcentaje) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Actividad_v4 <- join_all(list(Actividad_v2,Actividad_v3), by=c("Localizacion"),type = "full")

# Graficamos:
ggplot(Actividad_v4, aes(x=Porcentaje,y=Localizacion,fill=Inscripcion))+
  geom_col()+
  labs(x="Porcentaje",y="Localización",fill="Inscripción en RUT:")+
  geom_text(aes(label = Porcentaje),position = position_stack(0.5),
            size=4, vjust=0.5, hjust=0.5 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top")+
  scale_x_continuous(limits=c(0,100))

# Eliminamos intermedios
rm(Actividad,Actividad_v2,Actividad_v3,Actividad_v4)

#### Tema: Promedio de ingresos-Consolidado ####
# Pregunta data: "¿Cuál fue la ganancia neta en esta actividad el mes pasado?"

Proyectos <- PilotoProyectos %>%
  dplyr::select(LocaTotal,LocaUrbRur,"¿Cuál fue la ganancia neta en esta actividad el mes pasado?") %>%
  dplyr::rename(Ingresos="¿Cuál fue la ganancia neta en esta actividad el mes pasado?") %>% 
  dplyr::filter(Ingresos>0)

# Transformamos data a tipo numérico
Proyectos$Ingresos <- as.numeric(Proyectos$Ingresos)

# Encontramos promedios de Ingresos por localización:

# Total Area:
Proyectos_v2 <- Proyectos %>% 
  dplyr::group_by(LocaTotal)%>%
    dplyr::summarise(
      IngresosCol = round(mean(Ingresos,na.rm = TRUE),0)
      ) %>% 
  dplyr::rename(Localizacion=LocaTotal)

# Por Area :
Proyectos_v3 <- Proyectos %>% 
  dplyr::group_by(LocaUrbRur)%>%
    dplyr::summarise(
      IngresosCol = round(mean(Ingresos,na.rm = TRUE),0)
      ) %>% 
  dplyr::rename(Localizacion=LocaUrbRur)

# Concatenamos: 
Proyectos_v4 <- join_all(list(Proyectos_v2,Proyectos_v3), by=c("Localizacion"),type = "full")

# Graficamos:
ggplot(Proyectos_v4, aes(x=IngresosCol,y=Localizacion))+
  geom_bar(stat="identity", position="dodge",fill="cyan4")+
  labs(x="Ganancia mensual del negocio (promedio)",y="Localización")+
  geom_text(aes(label = IngresosCol),position = position_dodge(1),
            size=4, vjust=0.6, hjust=0 ,col="black")+
  theme(axis.title=element_text(size=rel(1.3)),
        axis.text.x=element_text(size=rel(1.3)),
        axis.text.y=element_text(size=rel(1.3)),
        legend.title=element_text(size=rel(1.1)),
        legend.text=element_text(size=rel(1)),
        legend.position="top",
        legend.direction = "vertical")+
  scale_x_continuous(limits=c(0,1300000))

# Eliminamos intermedios:
rm(Proyectos,Proyectos_v2,Proyectos_v3,Proyectos_v4)

```

```{r Calculos Diego}
#### Tasa Desempleo juvenil ####
# Definición:
# Tasa desempleo juvenil= desemplados (14y28 años)/ PEA (14 y 28 años)
# PEA= Ocupados+Desempleados

# Necesitamos solo personas entre 14 y 28 años.
Jovenes <- PilotoIndividuos %>%
  dplyr::select(.,c(LocaTotal,LocaUrbRur,Localizacion,"Edad de ${p_040}:","${p_040}. ¿En qué actividad ocupó la mayor parte del tiempo la semana pasada? [la predominante]")) %>%
  dplyr::rename(Edad="Edad de ${p_040}:",
                Actividad="${p_040}. ¿En qué actividad ocupó la mayor parte del tiempo la semana pasada? [la predominante]")%>% 
  dplyr::filter(Edad>=14 & Edad<=28)

# PEA entre 14 y 28 años
PEA_DF <- Jovenes %>% 
  dplyr::filter(Actividad=="Trabajando" |
                Actividad=="Buscando trabajo")

PEA_n <- nrow(PEA_DF)
PEA_n

# Desempleados entre 14 y 28 años:
DS_DF <- Jovenes %>% 
  dplyr::filter(Actividad=="Buscando trabajo")

DS_n <- nrow(DS_DF)
DS_n

# Tasa de Desempleo Juvenil:
TD <- round((DS_n/PEA_n)*100,2)
TD

#### Tasa Global Participación Juvenil ####
# Definición: PEA (14-28 años) / PET (14-28 años)

# PET entre 14 y 28 años:
PET_n <- nrow(Jovenes)
PET_n

# TGP entre 14y28 años
TGP <- round((PEA_n/PET_n)*100,2)
TGP

# Eliminamos intermedios
rm(Jovenes,PEA_DF,PEA_n,DS_DF,DS_n,TD,PET_n,TGP)
```
## Eliminación de intermedios
```{r pruebas, include=FALSE}
rm(Vivienda,Vivienda_v2)
# Evitemos la notación científica:
options(scipen=999)
# Para volver a notación cientifica:
# options(scipen=0)
urbano <-IngresosJerico %>% 
  dplyr::filter(.,Zona==1 & P_021>=12)
rural <-  IngresosJerico %>% 
  dplyr::filter(.,Zona==2 & P_021>=10)

 
```









